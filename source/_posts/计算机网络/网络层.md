

# 网络层提供的两种服务

# 网际协议IP
网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。

与IP协议配套使用的还有4个协议：
* 地址解析协议ARP（Address Resolution Protocol）
* 逆地址解析协议RARP（Reverse Resolution Protocol）
* 网际控制报文协议ICMP（Internet Control Message Protocol）
* 网际组管理协议IGMP（Internet Group Management Protocol）

{% asset_img img2.png 网际层的 IP 协议及配套协议 %}

由于网际协议IP是用来使互联起来的许多计算机网络能够进行通信，因此TCP/IP体系中的网络层也被称为网际层或 IP 层。
## 虚拟互联网络
互连在一起的网络要进行通信，会遇到许多问题需要解决，如：
* 不同的寻址方案
* 不同的最大分组长度
* 不同的网络接入机制
* 不同的超时控制
* 不同的差错恢复方法
* 不同的状态报告方法
* 不同的路由选择技术
* 不同的用户接入控制
* 不同的服务（面向连接服务和无连接服务）
* 不同的管理与控制方式 

将网络互相连接起来要使用一些中间设备，根据中间设备所在的层次，可以有以下4种不同的中间设备：
* 物理层使用的中间设备叫转发器
* 数据链路层使用的中间设备叫网桥或桥接器
* 网络层使用的中间设备叫路由器
* 网络层以上使用的设备叫网关

当中间设备是转发器或网桥时，这仅仅是把一个网络扩大了，而从网络层的角度看，这仍然是一个网络，一般并不称之为网络互连。网关由于比较复杂，使用的较少。因此我们讨论网络互连时都是指用路由器进行互连的网络。路由器其实就是一台专用计算机，用来在互联网中国进行路由选择。

{% asset_img img3.png 互连网络与虚拟互连网络 %}

所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。

使用 IP 协议的虚拟互连网络可简称为 IP 网。

使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。
## 分类的IP地址
### IP地址及其表示方法
整个的因特网就是一个单一、抽象的网络。IP 地址就是给因特网上的每一个主机（或路由器）的每一个接口分配一个在全世界唯一的32位标识符。IP 地址的结构使我们可以在因特网上很方便的进行寻址。

IP 地址现在由因特网名字与号码指派公司ICANN (Internet Corporation for Assigned Names and Numbers)进行分配。

IP 地址的编址方法共经历了三个阶段：
1. 分类的 IP 地址，这是最基本的编址方法。
2. 子网的划分，这是对最基本的编址方法的改进。
3. 构成超网，这是比较新的无分类编址方法。

所谓分类的 IP 地址就是将 IP 地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，其中第一个字段是网络号（net-id），它标志主机（或路由器）所连接到的网络，一个网络号在整个因特网范围内必须是唯一的。第二个字段是主机号（host-id），它标志该主机（或路由器）。一个主机号在它前面的网络号所指明的范围内必须是唯一的。由此可见，一个 IP 地址在整个因特网范围内是唯一的。

两级的 IP 地址可以记为：
```
IP 地址 ::= { <网络号>, <主机号>} 
::= 代表“定义为”
```
#### IP 地址中的网络号字段和主机号字段

{% asset_img img4.png IP 地址中的网络号字段和主机号字段 %}

A 类、B 类和 C 类都是单播地址（一对一通信）。
从图中可以看出：
* A 类、B 类和 C 类地址的网络号字段分别是1, 2, 3个字节长，在网络号字段的最前面有1~3位的类别位，其数值分别规定为0, 10, 110。
* A 类、B 类和 C 类地址的主机号字段分别为3, 2, 1个字节长。
* D 类地址（前4位是1110）用于多播（一对多通信）。
* E 类地址（前4位是1111）保留为以后用。

#### 点分十进制记法 
对主机或路由器来说，IP 地址都是32位二进制代码。为了提高可读性，我们常常把32位的 IP 地址中的每8位用其等效的十进制数字表示，并且在这些数字之间加上一个点，这叫点分十进制法。

{% asset_img img5.png IP 点分十进制记法 %}

### 常用的三种类别的IP地址
A 类地址的网络号字段占1个字节，只有7位可供使用（第一位已固定为0），但可指派的网络号是126个（即2^7 - 2）。

减2的原因：
1. IP 地址中的全0是保留地址，意思是本网络。
2. 网络号为127（即01111111）保留作为本地软件环回测试（loopback test）本主机的进程之间的通信。若主机发送一个 IP 地址为环回地址（如127.0.0.1）的 IP 数据报，则本机中的协议软件就处理数据报中的数据，而不会把数据报发送到任何网络。

A 类地址的主机号占3个字节，因此每一个 A 类网络中的最大主机数是2^24 - 2。

减2的原因：
1. 全0的主机号字段表示该 IP 地址是本主机所连接到的单个网络地址。如一台主机的 IP 地址为5.6.7.8，则该主机所在的网络地址就是5.0.0.0。
2. 全1的主机号字段表示该网络上的所有主机。

B 类地址的网络号字段有2个字节，但前面两位已经固定（10），只剩下14位可以进行分配。因为不可能出现网络号字段全0或全1，所以不存在减2的问题。但实际上 B 类网络地址128.0.0.0是不指派的，可以指派的 B 类最小网络地址是128.1.0.0。因此 B 类地址可指派的网络数为2^14 - 1。B 类地址的每一个网络上的最大主机数是2^16 - 2。减2是因为要扣除全0和全1的主机号。

C 类地址有3个字节的网络号字段，最前面的3位是（1 1 0），还有21位可分配。c 类网络地址192.0.0.0是不指派的，可以指派的 C 类最小网络地址是192.0.1.0，因此 C 类地址可指派的网络总数是2^21 - 1。每一个 C 类地址的最大主机数是2^8 - 2。

IP 地址的指派范围：

| 网络类别 | 最大网络数 | 第一个可用的网络号 | 每个网络中最大的主机数 |
| :--: | :--: | :--: | :--: |
| A | 126 (2^7 – 2) | 1 | 126 | 16,777,214 |
| B | 16,383(2^14 - 1) | 128.1 | 191.255 | 65,534 |
| C | 2,097,151 (2^21 - 1) | 192.0.1 | 223.255.255 | 254 |

#### IP 地址的一些重要特点
* 每一个 IP 地址都由网络号和主机号组成。IP 地址是一种分等级的地址结构。分两个等级的好处是：
 * 第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。
 * 第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。 
* 实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口。 
当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为多归属主机(multihomed host)。
由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址。 
* 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id。具有不同网络号的局域网必须使用路由器进行互连。
* 在 IP 地址中，所有分配到网络号的网络，不管是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。

{% asset_img img6.png 互联网中的 IP 地址 %}

图中画出了三个局域网LAN1、LAN2、LAN3，通过3个路由器R1、R2、R3互连起来所构成的一个互联网（虚线圆角方框表示）。局域网LAN2是由两个网段通过网桥 B 互连的。小圆圈表示需要有一个 IP 地址。

我们应当注意到：
1. 在同一个局域网上的主机或路由器的 IP 地址中的网络号必须是一样的。
2. 用网桥（它只在链路层工作）互连的网络仍然是一个局域网，只能有一个网络号。
3. 路由器总是具有两个或两个以上的 IP 地址。即路由器的每一个接口都有一个不同网络号的 IP 地址。 
4. 当两个路由器直接相连时，在连接两端的接口处，可以分配也可以不分配 IP 地址。如果分配了 IP 地址，则这一段连线就构成了一种只包含一段线路的特殊“网络” 。现在常不指明 IP 地址。这样的特殊网络叫无编号网络或无名网络。

## IP 地址与硬件地址

{% asset_img img7.png IP 地址与硬件地址的区别 %}

从层次的角度看，物理地址是数据链路层和物理层使用的地址，IP 地址是网络层和以上各层使用的地址，是一种逻辑地址，因为 IP 地址是用软件实现的。

在发送数据时，数据从高层下到低层，然后才到通信链路上传输。使用 IP 地址的 IP 数据报一旦交给了数据链路层，就被封装成 MAC 帧了。MAC 帧在传输时使用的源地址和目标地址都是硬件地址，这两个硬件地址都写在 MAC 帧的首部中。

连接在通信链路上的设备（主机或路由器）在接收 MAC 帧时，其根据是 MAC 帧首部中的硬件地址。在数据链路层看不见隐藏在 MAC 帧的数据中的 IP 地址。只有在剥去 MAC 帧的首部和尾部后把 MAC 层的数据上交给网络层后，网络层才能在 IP 数据报的首部中找到源 IP 地址和目的 IP 地址。

{% asset_img img8.png IP 地址与硬件地址的区别 %}

上图画的是3个局域网用两个路由器R1、R2互连起来。现在主机 H1 和主机 H2 通信。这两个主机的 IP 地址分别为 IP1、IP2，它们的硬件地址分别为HA1、HA2。通信的路径是：H1 → 经过 R1 转发 → 再经过 R2 转发 → H2。

路由器 R1 因同时连接到两个局域网上，因此它有两个硬件地址，HA3、HA4。同理，路由器 R2有两个硬件地址 HA5、HA6。

在 IP 层抽象的互联网上只能看到 IP 数据报。图中的 IP1 → IP2 表示从源地址 IP1 到目的地址 IP2，两个路由器的 IP 地址并不出现在 IP 数据报的首部中。

路由器只根据目的站的 IP 地址的网络号进行路由选择。

在具体的物理网络的链路层只能看见 MAC 帧而看不见 IP 数据报。

IP层抽象的互联网屏蔽了下层很复杂的细节，在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信。 
## 地址解析协议ARP和逆地址解析协议RARP
{% asset_img img9.png %}

ARP：通过 IP 地址找出其物理地址。
RARP：通过物理地址找出其 IP 地址。

### ARP
不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。

但 IP 地址和下面的网络的硬件地址之间由于格式不同而不存在简单的映射关系（IP 地址有32位，硬件地址48位）。此外，一个网络上可能经常会有新的主机加入进来，或撤走一些主机。更换网络适配器也会使主机的硬件地址改变。ARP 解决这个问题的办法是在主机 ARP 高速缓存中存放一个从 IP 地址到硬件地址的映射表，并且这个映射表还经常动态更新。

每一个主机都设有一个 ARP 高速缓存(ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。


## IP数据报的格式
IP 数据报的格式能够说明 IP 协议都具有什么功能。

{% asset_img img10.png IP数据报的格式 %}

一个 IP 数据报由首部和数据两部分组成。首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。

IP 数据报首部的固定部分中的各字段含义：
1. 版本：占 4 位，指 IP 协议的版本。
2. 首部长度：占 4 位，可表示的最大数值是 15，因此 IP 的首部长度的最大值是 60 字节。
3. 区分服务：占 8 位，用来获得更好的服务。只有在使用区分服务（DiffServ）时，这个字段才起作用。在一般的情况下都不使用这个字段。 
4. 总长度：占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 2^16 - 1。总长度必须不超过最大传送单元 MTU。
5. 标识：占 16 位，它是一个计数器，用来产生数据报的标识。
6. 标志：占 3 位，目前只有前两位有意义。
标志字段的最低位是 MF (More Fragment)。MF = 1 表示后面“还有分片”。MF = 0 表示最后一个分片。
标志字段中间的一位是 DF (Don't Fragment) 。只有当 DF = 0 时才允许分片。 
7. 片偏移：12 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。
8. 生存时间：占 8 位，记为 TTL (Time To Live)，数据报在网络中可通过的路由器数的最大值。数据报能在因特网中经过的路由器的最大数值是255。TTL = 1 表示这个数据报只能在本局域网中传送。
9. 协议：8 位，字段指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给哪个处理过程。
10. 首部校验和：占 16 位，只校验数据报的首部，不包括数据部分。

## IP层转发分组的流程



# 划分子网和超网
## 划分子网
### 从两级 IP 地址到三级 IP 地址
早期 IP 地址设计的不合理：
* IP 地址空间的利用率有时很低。 
* 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。 
* 两级的 IP 地址不够灵活。 

为解决上述问题，在 IP 地址中又增加了一个“子网号字段”，使两级的 IP 地址变成为三级的 IP 地址。这种做法叫做划分子网 (subnetting) 。

划分子网的基本思路：
1. 一个拥有很多物理网络的单位，可将所属的物理网络划分为若干个子网（subnet）。划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。
2. 划分子网的方法是从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。于是两级 IP 地址在本单位内部就变为三级 IP 地址：网络号、子网号和主机号。
```
IP地址 ::= {<网络号>, <子网号>, <主机号>}
```

{% asset_img img13.png %}

3. 凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。最后就将 IP 数据报直接交付目的主机。

{% asset_img img14.png %}

上图表示某单位拥有一个 B 类 IP 地址，网络地址是145.13.0.0。凡目的地址是145.13.x.x的数据报都被送到这个网络上的路由器R1。

{% asset_img img15.png %}

假定子网号占用 8 位，在增加了子网后，主机号就只有 8 位。所划分的
### 子网掩码
