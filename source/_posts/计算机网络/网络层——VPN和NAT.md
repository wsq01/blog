---
title: 网络层——VPN和NAT
date: 2020-10-09 16:51:33
tags: 计算机网络
categories: 计算机网络
---


# 虚拟专用网 VPN
VPN 技术还是企业比较常用的通信技术，如果一个企业的分公司和总部的互访，或者出差员工需要访问总部的网络，都会使用 VPN 技术。

在没有 VPN 之前，企业的总部和分部之间的互通都是采用运营商的 Internet 进行通信，那么 Internet 中往往是不安全的，通信的内容可能被窃取、修改等，从而造成安全事件。

那么有没有一种技术既能实现总部和分部间的互通，也能够保证数据传输的安全性呢？

当然有，那就是 VPN。VPN 通过在现有的 Internet 网中构建专用的虚拟网络，实现企业总部和分部的通信，解决了互通、安全、成本的问题。
## 什么是 VPN
`VPN(Virtual Private Network)`即虚拟专用网，指通过 VPN 技术在公有网络中构建专用的虚拟网络。
* 专用：VPN 虚拟网络是专门为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。
* 虚拟：相对于公有网络而言，VPN网络是虚拟的，是逻辑意义上的一个专网。

RFC 指明了一些专用地址。专用地址只能用作本地地址而不能用作全球地址。在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发。

{% asset_img img1.png %}

采用这样的专用 IP 地址的互连网络称为专用互联网或就叫做专用网。

{% asset_img img2.png %}

如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的数据都必须加密。

{% asset_img img3.png %}

## VPN技术优势
* 安全：在远端用户、驻外机构、合作伙伴、供应商与公司总部之间建立可靠的连接，保证数据传输的安全性。这对于实现电子商务或金融网络与通讯网络的融合特别重要。
* 成本低：利用公共网络进行信息通讯，企业可以用更低的成本连接远程办事机构、出差人员和业务伙伴。
* 支持移动业务：支持出差 VPN 用户在任何时间、任何地点的移动接入，能够满足不断增长的移动业务需求。
* 可扩展性：由于 VPN 为逻辑上的网络，物理网络中增加或修改节点，不影响 VPN 的部署。

## 内联网和外联网
它们都是基于 TCP/IP 协议的。

由部门 A 和 B 的内部网络所构成的虚拟专用网 VPN 又称为内联网(`intranet`)，表示部门 A 和 B 都是在同一个机构的内部。一个机构和某些外部机构共同建立的虚拟专用网 VPN 又称为外联网(`extranet`)。 

{% asset_img img4.png %}

远程接入 VPN 可以满足外部流动员工访问公司网络的需求。

在外地工作的员工拨号接入互联网，而驻留在员工 PC 机中的 VPN 软件可在员工的 PC 机和公司的主机之间建立 VPN 隧道，因而外地员工与公司通信的内容是保密的，员工们感到好像就是使用公司内部的本地网络。 
## VPN分类
### 根据 VPN 建设单位不同进行划分
#### 1. 租用运营商VPN专线搭建企业网络

运营商的专线网络大多数都是使用的MPLS VPN。

企业通过购买运营商提供的 VPN 专线服务实现总部和分部间的通信需求。VPN网关为运营商所有。

{% asset_img 5.png %}

#### 2. 企业自建VPN网络
企业自己基于 Internet 自建 VPN 网络，常见的如 IPsec VPN、GRE VPN、L2TP VPN。

{% asset_img 6.png %}

### 根据组网方式进行划分
1. 远程访问VPN
这种方式适用于出差员工拨号接入 VPN 的方式，员工可以在只要有 Internet 的地方都可以通过 VPN 接入访问内网资源。
最常见的就是SSL VPN、L2TP VPN。
2. 站点到站点的VPN
这种方式适用于企业两个局域网互通的情况。例如企业的分部访问总部。最常见的就是 MPLS VPN、IPSEC VPN。

### 根据工作网络层次进行划分
VPN可以按照工作层次进行划分：
* 应用层：SSL VPN
* 网络层：IPSEC VPN 、GRE VPN
* 数据链路层：L2TP VPN、PPTP VPN

{% asset_img 7.png %}

## VPN关键技术
### 隧道技术
VPN技术的基本原理其实就是用的隧道技术，就类似于火车的轨道、地铁的轨道一样，从 A 站点到 B 站点都是直通的，不会堵车。对于乘客而言，就是专车。

隧道技术其实就是对传输的报文进行封装，利用公网的建立专用的数据传输通道，从而完成数据的安全可靠性传输。

{% asset_img 8.png %}

可以看到原始报文在隧道的一端进行封装，封装后的数据在公网上传输，在隧道另一端进行解封装，从而实现了数据的安全传输。

隧道通过隧道协议实现。如`GRE（Generic Routing Encapsulation）、L2TP（Layer 2 Tunneling Protocol）`等。

隧道协议通过在隧道的一端给数据加上隧道协议头，即进行封装，使这些被封装的数据能都在某网络中传输，并且在隧道的另一端去掉该数据携带的隧道协议头，即进行解封装。

{% asset_img 9.png %}

### 身份认证、数据加密、数据验证
身份认证、数据加密、数据验证可以有效保证 VPN 网络和数据的安全性。
* 身份认证：VPN网关对接入VPN的用户进行身份认证，保证接入的用户都是合法用户。
* 数据加密：将明文通过加密技术成密文，哪怕信息被获取了，也无法识别。
* 数据验证：通过数据验证技术验证报文的完整性和真伪进行检查，防止数据被篡改。

|  VPN  | 用户身份认证 | 数据加密和验证 | 备注 |
| :--: | :--: | :--: | :--: |
|  GRE  | 不支持 | 支持简单的关键字验证、校验和验证 | 可结合 IPSec 使用 |
| L2TP  | 支持基于 PPP 的CHAP、PAP、EAP 认证 | 不支持 | 可结合 IPSec 使用 |
| IPSec | 支持 | 支持 | 支持预共享密钥验证或证书验证；支持 IKEv2 的 EAP 认证 |
|  SSL  | 支持 | 支持 | 支持用户名/密码或证书认证 |
| MPLS  | 不支持 | 不支持 | 一般运行在专用的 VPN 骨干网络 |

# 网络地址转换 NAT
在专用网上使用专用地址的主机如何与互联网上的主机通信（并不需要加密）？

再申请一些全球 IP 地址。但这在很多情况下是不容易做到的。目前使用得最多的方法是采用网络地址转换 NAT(`Network Address Translation`)。

需要在专用网连接到互联网的路由器上安装 NAT 软件。装有 NAT 软件的路由器叫做 NAT 路由器，它至少有一个有效的外部全球 IP 地址。

所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器上将其本地地址转换成全球 IP 地址，才能和互联网连接。

为了简单，我们假设你很富，你家里分到了一个公网 IP 地址`20.20.20.20`，对应配到了你家自带 NAT 功能的家用路由器上，你家里需要上网的设备有很多，比如你的手机，电脑都需要上网，他们构成了一个局域网，用的都是私有 IP，比如`192.168.xx`。其中你在电脑上执行`ifconfig`命令，发现家里的电脑 IP 是`192.168.30.5`。你要访问的公网 IP 地址是`30.30.30.30`。

{% asset_img 10.png %}

当你准备发送数据包的时候，你的电脑内核协议栈就会构造一个 IP 数据包。这个 IP 数据包报头里的发送端 IP 地址填的就是`192.168.30.5`，接收端 IP 地址就是`30.30.30.30`。将数据包发到 NAT 路由器中。

此时 NAT 路由器会将 IP 数据包里的源 IP 地址修改一下，私有IP地址`192.168.30.5`改写为公网 IP 地址`20.20.20.20`，这叫 SNAT（`Source Network Address Translation`，源地址转换）。并且还会在 NAT 路由器内部留下一条`192.168.30.5 -> 20.20.20.20`的映射记录，这个信息会在后面用到。之后 IP 数据包经过公网里各个路由器的转发，发到了接收端`30.30.30.30`，到这里发送流程结束。

{% asset_img 11.png %}

如果接收端处理完数据了，需要发一个响应给你的电脑，那就需要将发送端 IP 地址填上自己的`30.30.30.30`，将接收端地址填为你的公网 IP 地址`20.20.20.20`，发往 NAT 路由器。NAT 路由器收到公网来的消息之后，会检查下自己之前留下的映射信息，发现之前留下了这么一条`192.168.30.5 -> 20.20.20.20`记录，就会将这个数据包的目的 IP 地址修改一下，变成内网 IP 地址`192.168.30.5`, 这也叫 DNAT（`Destination Network Address Translation`，目的地址转换）。之后将其转发给你的电脑上。

{% asset_img 12.png %}

整个过程下来，NAT 悄悄的改了 IP 数据包的发送和接收端 IP 地址，但对真正的发送方和接收方来说，他们却对这件事情，一无所知。

这就是 NAT 的工作原理。

当 NAT 路由器具有`n`个全球 IP 地址时，专用网内最多可以同时有`n`台主机接入到互联网。这样就可以使专用网内较多数量的主机，轮流使用 NAT 路由器有限数量的全球 IP 地址。

通过 NAT 路由器的通信必须由专用网内的主机发起。专用网内部的主机不能充当服务器用，因为互联网上的客户无法请求专用网内的服务器提供服务。

为了更加有效地利用 NAT 路由器上的全球 IP 地址，现在常用的 NAT 转换表把运输层的端口号也利用上。这样，就可以使多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，因而可以同时和互联网上的不同主机进行通信。

使用端口号的 NAT 叫做网络地址与端口号转换 NAPT(`Network Address and Port Translation`)，而不使用端口号的 NAT 就叫做传统的 NAT(`traditional NAT`)。

## NAPT的原理
局域网里并不只有一台机器，局域网内每台机器都在 NAT 下留下的映射信息都会是`192.168.xx.xx -> 20.20.20.20`，发送消息是没啥事，但接收消息的时候就不知道该回给谁了。

{% asset_img 13.png %}

这问题相当致命，因此实际上大部分时候不会使用普通的 NAT。

问题出在我们没办法区分内网里的多个网络连接。

于是乎。

我们可以加入其他信息去区分内网里的各个网络连接，很自然就能想到端口。

但 IP 数据包（网络层）本身是没有端口信息的。常见的传输层协议 TCP 和 UDP 数据报文里才有端口的信息。

{% asset_img 14.png %}

{% asset_img 15.png %}

于是流程就变成了下面这样子。

当你准备发送数据包的时候，你的电脑内核协议栈就会先构造一个 TCP 或者 UDP 数据报头，里面写入端口号，比如发送端口是 5000，接收端口是 3000，然后在这个基础上，加入 IP 数据报头，填入发送端和接收端的 IP 地址。

那数据包长这样。

{% asset_img 16.png %}

假设，发送端 IP 地址填的就是`192.168.30.5`，接收端 IP 地址就是`30.30.30.30`。

将数据包发到 NAT 路由器中。

此时 NAT 路由器会将 IP 数据包里的源 IP 地址和端口号修改一下，从`192.168.30.5:5000`改写成`20.20.20.20:6000`。并且还会在 NAT 路由器内部留下一条`192.168.30.5:5000 -> 20.20.20.20:6000`的映射记录。之后数据包经过公网里各个路由器的转发，发到了接收端`30.30.30.30:3000`，到这里发送流程结束。

{% asset_img 17.png %}

接收端响应时，就会在数据包里填入发送端地址是`30.30.30.30:3000`，将接收端是`20.20.20.20:6000`，发往 NAT 路由器。NAT 路由器发现下自己之前留下过这么一条`192.168.30.5:5000 -> 20.20.20.20:6000`的记录，就会将这个数据包的目的IP地址和端口修改一下，变回原来的`192.168.30.5:5000`。之后将其转发给你的电脑上。

{% asset_img 18.png %}

如果局域网内有多个设备，他们就会映射到不同的公网端口上，毕竟端口最大可达 65535，完全够用。这样大家都可以相安无事。

像这种同时转换 IP 和端口的技术，就是 NAPT（`Network Address Port Transfer`, 网络地址端口转换 ）。

那这么说只有用到端口的网络协议才能被 NAT 识别出来并转发？

但这怎么解释`ping`命令？`ping`基于 ICMP 协议，而 ICMP 协议报文里并不带端口信息。我依然可以正常的`ping`通公网机器并收到回包。

{% asset_img 19.png %}

事实上针对 ICMP 协议，NAT 路由器做了特殊处理。`ping`报文头里有个`Identifier`的信息，它其实指的是放出`ping`命令的进程`id`。

对 NAT 路由器来说，这个`Identifier`的作用就跟端口一样。

另外，当我们去抓包的时候，就会发现有两个`Identifier`，一个后面带个BE（Big Endian），另一个带个LE（Little Endian）。

其实他们都是同一个数值，只不过大小端不同，读出来的值不一样。就好像同样的数字 345，反着读就成了 543。这是为了兼容不同操作系统下大小端不同的情况。

{% asset_img 20.png %}

# 内网穿透是什么
使用了 NAT 上网的话，前提得内网机器主动请求公网 IP，这样 NAT 才能将内网的 IP 端口转成外网 IP 端口。

反过来公网的机器想主动请求内网机器，就会被拦在 NAT 路由器上，此时由于 NAT 路由器并没有任何相关的 IP 端口的映射记录，因此也就不会转发数据给内网里的任何一台机器。

举个现实中的场景就是，你在你家里的电脑上启动了一个 HTTP 服务，地址是`192.168.30.5:5000`，此时你在公司办公室里想通过手机去访问一下，却发现访问不了。

那问题就来了，有没有办法让外网机器访问到内网的服务？

有。

说到底，因为 NAT 的存在，我们只能从内网主动发起连接，否则 NAT 设备不会记录相应的映射关系，没有映射关系也就不能转发数据。

所以我们就在公网上加一台服务器x，并暴露一个访问域名，再让内网的服务主动连接服务器x，这样 NAT 路由器上就有对应的映射关系。接着，所有人都去访问服务器x，服务器x将数据转发给内网机器，再原路返回响应，这样数据就都通了。这就是所谓的内网穿透。

像上面提到的服务器x，你也不需要自己去搭，已经有很多现成的方案，比如花某壳。

{% asset_img 21.png %}

### 为什么我在公司里访问不了家里的电脑？
那是因为家里的电脑在局域网内，局域网和广域网之间有个 NAT 路由器。由于 NAT 路由器的存在，外网服务无法主动连通局域网内的电脑。
### 两个内网的聊天软件如何建立通讯
我家机子是在我们小区的局域网里，班花家的机子也是在她们小区的局域网里。都在局域网里，且 NAT 只能从内网连到外网，那我电脑上登录的QQ是怎么和班花电脑里的QQ连上的呢？

{% asset_img 22.png %}

上面这个问法其实是存在个误解，误以为两个qq客户端应用是直接建立连接的。

然而实际上并不是，两个qq客户端之间还隔了一个服务器。

{% asset_img 23.png %}

也就是说，两个在内网的客户端登录qq时都会主动向公网的聊天服务器建立连接，这时两方的 NAT 路由器中都会记录有相应的映射关系。当在其中一个qq上发送消息时，数据会先到服务器，再通过服务器转发到另外一个客户端上。反过来也一样，通过这个方式让两台内网的机子进行数据传输。
## 两个内网的应用如何直接建立连接
上面的情况，是两个客户端通过第三方服务器进行通讯，但有些场景就是要抛开第三端，直接进行两端通信，比如P2P下载，这种该怎么办呢？

这种情况下，其实也还是离不开第三方服务器的帮助。

假设还是 A 和 B 两个局域网内的机子，A 内网对应的 NAT 设备叫`NAT_A`，B 内网里的 NAT 设备叫`NAT_B`，和一个第三方服务器`server`。

流程如下。

step1和2: A 主动去连`server`，此时A对应的`NAT_A`就会留下 A 的内网地址和外网地址的映射关系，`server`也拿到了 A 对应的外网 IP 地址和端口。

step3和4: B 的操作和 A 一样，主动连第三方`server`，`NAT_B`内留下 B 的内网地址和外网地址的映射关系，然后`server`也拿到了 B 对应的外网 IP 地址和端口。

step5和step6以及step7: 重点来了。此时`server`发消息给 A，让 A 主动发 UDP 消息到 B 的外网 IP 地址和端口。此时`NAT_B`收到这个 A 的 UDP 数据包时，这时候根据`NAT_B`的设置不同，导致这时候有可能`NAT_B`能直接转发数据到 B，那此时 A 和 B 就通了。但也有可能不通，直接丢包，不过丢包没关系，这个操作的目的是给`NAT_A`上留下有关 B 的映射关系。

step8和step9以及step10: 跟step5一样熟悉的配方，此时`server`再发消息给 B，让 B 主动发 UDP 消息到 A 的外网 IP 地址和端口。`NAT_B`上也留下了关于 A 到映射关系，这时候由于之前`NAT_A`上有过关于 B 的映射关系，此时`NAT_A`就能正常接受 B 的数据包，并将其转发给 A。到这里 A 和 B 就能正常进行数据通信了。这就是所谓的 NAT 打洞。

step11: 注意，之前我们都是用的 UDP 数据包，目的只是为了在两个局域网的 NAT 上打个洞出来，实际上大部分应用用的都是 TCP 连接，所以，这时候我们还需要在 A 主动向 B 发起 TCP 连接。到此，我们就完成了两端之间的通信。

{% asset_img 24.png %}

这里估计大家会有疑惑。

端口已经被 udp 用过了，TCP 再用，那岂不是端口重复占用（address already in use）？

其实并不会，端口重复占用的报错常见于两个 TCP 连接在不使用`SO_REUSEADDR`的情况下，重复使用了某个 IP 端口。而 UDP 和 TCP 之间却不会报这个错。之所以会有这个错，主要是因为在一个linux内核中，内核收到网络数据时，会通过五元组（传输协议，源 IP，目的 IP，源端口，目的端口）去唯一确定数据接受者。当五元组都一模一样的时候，内核就不知道该把数据发给谁。而 UDP 和 TCP 之间"传输协议"不同，因此五元组也不同，所以也就不会有上面的问题。

{% asset_img 25.png %}

NAPT 还分为好多种类型，上面的 nat 打洞方案，都能成功吗？

关于 NAPT，确实还细分为好几种类型。我们现在常见的都是锥形 NAT。上面的打洞方案适用于大部分场景，这其中包括限制最多的端口受限锥形 NAT。

{% asset_img 26.png %}

## 总结
IPV4 地址有限，但通过 NAT 路由器，可以使得整个内网 N 多台机器，对外只使用一个公网 IP，大大节省了 IP 资源。

内网机子主动连接公网 IP，中间的 NAT 会将内网机子的内网 IP 转换为公网 IP，从而实现内网和外网的数据交互。

普通的 NAT 技术，只会修改网络包中的发送端和接收端 IP 地址，当内网设备较多时，将有可能导致冲突。因此一般都会使用 NAPT 技术，同时修改发送端和接收端的 IP 地址和端口。

由于 NAT 的存在，公网 IP 是无法访问内网服务的，但通过内网穿透技术，就可以让公网 IP 访问内网服务。一波操作下来，就可以在公司的网络里访问家里的电脑。