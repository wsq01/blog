---
title: 应用层——FTP
date: 2020-10-20 10:57:33
tags: 计算机网络
categories: 计算机网络
---

# FTP 概述
文件传送协议 FTP(`File Transfer Protocol`) 是互联网上使用得最广泛的文件传送协议。

FTP 提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。

FTP 屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件。

网络环境中的一项基本应用就是将文件从一台计算机中复制到另一台可能相距很远的计算机中。
# FTP 的基本工作原理
初看起来，在两个主机之间传送文件是很简单的事情。其实这往往非常困难。原因是众多的计算机厂商研制出的文件系统多达数百种，且差别很大。 

网络环境下复制文件的复杂性：
* 计算机存储数据的格式不同。
* 文件的目录结构和文件命名的规定不同。
* 对于相同的文件存取功能，操作系统使用的命令不同。
* 访问控制方法不同。

## FTP 特点
* 文件传送协议 FTP 只提供文件传送的一些基本的服务，它使用 TCP 可靠的运输服务。
* FTP 的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。
* FTP 使用客户服务器方式。一个 FTP 服务器进程可同时为多个客户进程提供服务。FTP 的服务器进程由两大部分组成：一个主进程，负责接受新的请求；另外有若干个从属进程，负责处理单个请求。

## 主进程的工作步骤
1. 打开熟知端口（端口号为 21），使客户进程能够连接上。
2. 等待客户进程发出连接请求。
3. 启动从属进程来处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程。
4. 回到等待状态，继续接受其他客户进程发来的请求。主进程与从属进程的处理是并发地进行。

## 两个连接
服务器端有两个从属进程：控制进程和数据传送进程。客户端主要有控制进程、数据传送进程和用户界面进程。

在进行文件传输时，FTP 客户和服务器之间要建立两个并行的 TCP 连接：控制连接和数据连接。

控制连接在整个会话期间一直保持打开，FTP 客户发出的传送请求通过控制连接发送给服务器端的控制进程，但控制连接不用来传送文件。

实际用于传输文件的是“数据连接”。服务器端的控制进程在接收到 FTP 客户发送来的文件传输请求后就创建“数据传送进程”和“数据连接”，用来连接客户端和服务器端的数据传送进程。

数据传送进程实际完成文件的传送，在传送完毕后关闭“数据传送连接”并结束运行。
## FTP 使用的两个 TCP 连接

{% asset_img img1.png %}

## 两个不同的端口号
当客户进程向服务器进程发出建立连接请求时，要寻找连接服务器进程的熟知端口(21)，同时还要告诉服务器进程自己的另一个端口号码，用于建立数据传送连接。

接着，服务器进程用自己传送数据的熟知端口(20)与客户进程所提供的端口号码建立数据传送连接。

由于 FTP 使用了两个不同的端口号，所以数据连接与控制连接不会发生混乱。

使用两个不同端口号的好处：
* 使协议更加简单和更容易实现。
* 在传输文件时还可以利用控制连接（例如，客户发送请求终止传输）。

## NFS 采用另一种思路
网络文件系统 NFS 允许应用进程打开一个远地文件，并能在该文件的某一个特定的位置上开始读写数据。

NFS 可使用户只复制一个大文件中的一个很小的片段，而不需要复制整个大文件。

例如，计算机 A 的 NFS 客户软件，把要添加的数据和在文件后面写数据的请求一起发送到远地的计算机 B 的 NFS 服务器。NFS 服务器更新文件后返回应答信息。

NFS 在网络上传送的只是少量的修改数据。 
# 简单文件传送协议 TFTP
TFTP(`Trivial File Transfer Protocol`) 是一个很小且易于实现的文件传送协议。

TFTP 使用客户服务器方式和使用 UDP 数据报，因此 TFTP 需要有自己的差错改正措施。

TFTP 只支持文件传输而不支持交互。

TFTP 没有一个庞大的命令集，没有列目录的功能，也不能对用户进行身份鉴别。 
## TFTP 的主要特点
* 每次传送的数据 PDU 中有 512 字节的数据，但最后一次可不足 512 字节。
* 数据 PDU 也称为文件块，每个块按序编号，从 1 开始。
* 支持 ASCII 码或二进制传送。
* 可对文件进行读或写。
* 使用很简单的首部。 

TFTP 的工作很像停止等待协议：
* 发送完一个文件块后就等待对方的确认，确认时应指明所确认的块编号。
* 发完数据后在规定时间内收不到确认就要重发数据 PDU。
* 发送确认 PDU 的一方若在规定时间内收不到下一个文件块，也要重发确认 PDU。这样就可保证文件的传送不致因某一个数据报的丢失而告失败。 

开始工作时，TFTP 客户进程发送一个读请求 PDU 或写请求 PDU 给 TFTP 服务器进程，其熟知端口号码为 69。

TFTP 服务器进程要选择一个新的端口和 TFTP 客户进程进行通信。

若文件长度恰好为 512 字节的整数倍，则在文件传送完毕后，还必须在最后发送一个只含首部而无数据的数据 PDU。

若文件长度不是 512 字节的整数倍，则最后传送数据 PDU 的数据字段一定不满 512 字节，这正好可作为文件结束的标志。
