---
title: 运输层——用户数据报协议 UDP
date: 2020-10-14 18:28:43
tags: 计算机网络
categories: 计算机网络
---

# UDP 概述
UDP 只在 IP 的数据报服务之上增加了很少的功能：复用和分用、差错检测。

{% asset_img img12.png %}

## UDP 的特点
* UDP 是无连接的，发送数据之前不需要建立连接，因此减少了开销和发送数据之前的时延。
* UDP 使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表。
* UDP 是面向报文的。
* UDP 没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。如 IP 电话、实时视频会议等。 
* UDP 支持一对一、一对多、多对一和多对多的交互通信。
* UDP 的首部开销小，只有 8 个字节，比 TCP 的 20 个字节的首部要短。

## 面向报文的 UDP 解释
发送方 UDP 对应用程序交下来的报文，在添加首部后就向下交付 IP 层。UDP 对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。即应用层交给 UDP 多长的报文，UDP 就照样发送，即一次发送一个报文。

接收方 UDP 对 IP 层交上来的 UDP 用户数据报，在去除首部后就原封不动地交付上层的应用进程，一次交付一个完整的报文。因此应用程序必须选择合适大小的报文。
* 若报文太长，UDP 把它交给 IP 层后，IP 层在传送时可能要进行分片，这会降低 IP 层的效率。
* 若报文太短，UDP 把它交给 IP 层后，会使 IP 数据报的首部的相对长度太大，这也降低了 IP 层的效率。

{% asset_img img13.png %}
{% asset_img img14.png %}

# UDP 的首部格式
用户数据报 UDP 有两个字段：数据字段和首部字段。

首部字段有 8 个字节，由 4 个字段组成，每个字段都是 2 个字节。
* 源端口：源端口号。在需要对方回信时选用。不需要时可用全 0；
* 目的端口：目的端口号。这在终点交付报文时必须使用；
* 长度：UDP 用户数据报的长度，其最小值是 8 (仅有首部)；
* 检验和：检测 UDP 用户数据报在传输中是否有错。有错就丢弃。

{% asset_img img15.png %}

## UDP 基于端口的分用
当运输层从 IP 层收到 UDP 数据报时，就根据首部中的目的端口，把 UDP 数据报通过相应的端口，上交给最后的终点——应用进程。

如果接收方 UDP 发现收到的报文中的目的端口号不正确(即不存在对应于该端口号的应用进程)，就丢弃该报文，并由网际控制报文协议 ICMP 发送“端口不可达”差错报文给发送方。

> 注意，虽然在 UDP 之间的通信要用到端口号，但由于 UDP 的通信是无连接的，因此不需要使用套接字来建立连接(TCP之间的通信必须要在两个套接字之间建立连接)。

{% asset_img img16.png %}
<br>
{% asset_img img17.png %}

计算检验和时，要在 UDP 用户数据报之前增加 12 个字节的伪首部。所谓“伪首部”是因为这种伪首部并不是 UDP 用户数据报真正的首部。只是在计算检验和时，临时添加在 UDP 用户数据报前面，得到一个临时的  UDP 用户数据报。检验和就是按照这个临时的 UDP 用户数据报来计算的。伪首部既不向下传送也不向上递交，而仅仅是为了计算检验和。
## 计算 UDP 检验和的例子
UDP 计算检验和的方法和计算 IP 数据报首部检验和的方法相似。但不同的是：IP数据报的检验和只检验 IP 数据报的首部，但 UDP 的检验和是把首部和数据部分一起都检验。

在发送方，首先是先把全零放入检验和字段。再把伪首部以及 UDP 用户数据报看成是由许多 16 位的字串接起来的。若 UDP 用户数据报的数据部分不是偶数个字节，则要填入一个全零字节（但此字节不发送）。然后按二进制反码计算出这些 16 位字的和。将此和的二进制反码写入检验和字段后，就发送这样的 UDP 用户数据报。

在接收方，把收到的 UDP 用户数据报连同伪首部（以及可能的填充全零字节）一起，按二进制反码求这些 16 位字的和。当无差错时其结果应为全 1。否则就表明有差错出现，接收方就应丢弃这个 UDP 用户数据报（也可以上交给应用层，但附上出现了差错的警告）。

这里假定用户数据报的长度是 15 字节，因此要添加一个全 0 的字节。

{% asset_img img18.png %}

伪首部的第 3 字段是全零；第 4 字段是 IP 首部中的协议字段的值。对于 UDP 此协议字段值为 17；第 5 字段是 UDP 用户数据报的长度。因此，这样的检验和，既检查了 UDP 用户数据报的源端口号和目的端口号以及 UDP 用户数据报的数据部分，又检查了 IP 数据报的源 IP 地址和目的地址。