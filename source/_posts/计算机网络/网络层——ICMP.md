---
title: 网络层——ICMP
date: 2022-01-19 11:49:21
tags: [计算机网络]
categories: 计算机网络
---

ICMP 全称是`Internet Control Message Protocol`，也就是互联⽹控制报文协议。

⽹络包在复杂的⽹络传输环境⾥，常常会遇到各种问题。当遇到问题的时候，总不能死的不明不⽩，没头没脑的作⻛不是计算机⽹络的⻛格。所以需要传出消息，报告遇到了什么问题，这样才可以调整传输策略，以此来控制整个局⾯。

ICMP 主要的功能包括：确认 IP 包是否成功送达⽬标地址、报告发送过程中 IP 包被废弃的原因和改善⽹络设置等。

在 IP 通信中如果某个 IP 包因为某种原因未能达到⽬标地址，那么这个具体的原因将由 ICMP 负责通知。

{% asset_img 1.jpg %}

ICMP 的这种通知消息会使⽤ IP 进⾏发送。

因此，从路由器 2 返回的 ICMP 包会按照往常的路由控制先经过路由器 1 再转发给主机 A 。收到该 ICMP 包的主机 A 则分解 ICMP 的⾸部和数据域以后得知具体发⽣问题的原因。
# ICMP 包头格式
ICMP 报文是封装在 IP 包⾥⾯，它⼯作在⽹络层，因而不保证可靠的提交。

{% asset_img 2.jpg %}

ICMP 包头的类型字段，⼤致可以分为两⼤类：
* ⼀类是⽤于诊断的查询消息，也就是「查询报文类型」
* 另⼀类是通知出错原因的错误消息，也就是「差错报文类型」

{% asset_img 3.jpg %}

# 查询报文类型
回送消息⽤于进⾏通信的主机或路由器之间，判断所发送的数据包是否已经成功到达对端的⼀种消息， ping 命令就是利⽤这个消息实现的。

{% asset_img 4.jpg %}

可以向对端主机发送回送请求的消息（ICMP Echo Request Message，类型 8），也可以接收对端主机发回来的回送应答消息（ICMP Echo Reply Message，类型 0）。

{% asset_img 5.jpg %}

相比原生的 ICMP，这里多了两个字段：
* 标识符：用以区分是哪个应用程序发 ICMP 包，比如用进程 PID 作为标识符；
* 序号：序列号从 0 开始，每发送一次新的回送请求就会加 1， 可以用来确认网络包是否有丢失。

在选项数据中，ping 还会存放发送请求的时间值，来计算往返时间，说明路程的长短。
# 差错报文类型
几个常用的 ICMP 差错报文的例子：
* 目标不可达消息 —— 类型 为 3
* 原点抑制消息 —— 类型 4
* 重定向消息 —— 类型 5
* 超时消息 —— 类型 11

## 目标不可达消息
IP 路由器无法将 IP 数据包发送给目标地址时，会给发送端主机返回一个目标不可达的 ICMP 消息，并在这个消息中显示不可达的具体原因，原因记录在 ICMP 包头的代码字段。

由此，根据 ICMP 不可达的具体消息，发送端主机也就可以了解此次发送不可达的具体原因。

6 种常见的目标不可达类型的代码：
* 0：网络不可达
* 1：主机不可达
* 2：协议不可达
* 3：端口不可达
* 4：需要进行分片但设置了不分片

⽹络不可达代码为 0：
* IP 地址是分为⽹络号和主机号的，所以当路由器中的路由器表匹配不到接收⽅ IP 的⽹络号，就通过 ICMP 协议以⽹络不可达（`Network Unreachable`）的原因告知主机。

⾃从不再有⽹络分类以后，⽹络不可达也渐渐不再使⽤了。

主机不可达代码为 1：
* 当路由表中没有该主机的信息，或者该主机没有连接到⽹络，那么会通过 ICMP 协议以主机不可达（`Host Unreachable`）的原因告知主机。

协议不可达代码为 2：
* 当主机使⽤ TCP 协议访问对端主机时，能找到对端的主机了，可是对端主机的防⽕墙已经禁⽌ TCP 协议访问，那么会通过 ICMP 协议以协议不可达的原因告知主机。

端⼝不可达代码为 3：
* 当主机访问对端主机 8080 端⼝时，这次能找到对端主机了，防⽕墙也没有限制，可是发现对端主机没有进程监听 8080 端⼝，那么会通过 ICMP 协议以端⼝不可达的原因告知主机。

需要进⾏分⽚但设置了不分⽚位代码为 4：
* 发送端主机发送 IP 数据报时，将 IP ⾸部的分⽚禁⽌标志位设置为 1 。根据这个标志位，途中的路由器遇到超过MTU ⼤⼩的数据包时，不会进⾏分⽚，而是直接抛弃。

随后，通过⼀个 ICMP 的不可达消息类型，代码为 4 的报文，告知发送端主机。
## 原点抑制消息
在使⽤低速⼴域线路的情况下，连接 WAN 的路由器可能会遇到⽹络拥堵的问题。ICMP 原点抑制消息的⽬的就是为了缓和这种拥堵情况。

当路由器向低速线路发送数据时，其发送队列的缓存变为零而⽆法发送出去时，可以向 IP 包的源地址发送⼀个 ICMP 原点抑制消息。

收到这个消息的主机借此了解在整个线路的某⼀处发⽣了拥堵的情况，从而增⼤ IP 包的传输间隔，减少⽹络拥堵的情况。

然而，由于这种 ICMP 可能会引起不公平的⽹络通信，⼀般不被使⽤。
## 重定向消息
如果路由器发现发送端主机使⽤了「不是最优」的路径发送数据，那么它会返回⼀个 ICMP 重定向消息给这个主机。

在这个消息中包含了最合适的路由信息和源数据。这主要发⽣在路由器持有更好的路由信息的情况下。路由器会通过这样的 ICMP 消息告知发送端，让它下次发给另外⼀个路由器。
## 超时消息
IP 包中有⼀个字段叫做 TTL（`Time To Live`，⽣存周期），它的值随着每经过⼀次路由器就会减 1，直到减到 0 时该 IP 包会被丢弃。

此时，路由器将会发送⼀个 ICMP 超时消息给发送端主机，并通知该包已被丢弃。

设置 IP 包⽣存周期的主要⽬的，是为了在路由控制遇到问题发⽣循环状况时，避免 IP 包⽆休⽌地在⽹络上被转发。

{% asset_img 7.jpg %}

此外，有时可以⽤ TTL 控制包的到达范围，例如设置⼀个较⼩的 TTL 值。
# ping — 查询报文类型的使⽤
接下来，我们来看 ping 的发送和接收过程。

同个⼦⽹下的主机 A 和 主机 B，主机 A 执⾏ ping 主机 B 后，我们来看看其间发送了什么。

{% asset_img 8.jpg %}

ping 命令执⾏的时候，源主机⾸先会构建⼀个 ICMP 回送请求消息数据包。

ICMP 数据包内包含多个字段，最重要的是两个：
* 第⼀个是类型，对于回送请求消息而⾔该字段为 8；
* 另外⼀个是序号，主要⽤于区分连续 ping 的时候发出的多个数据包。

每发出⼀个请求数据包，序号会⾃动加 1。为了能够计算往返时间 RTT，它会在报文的数据部分插⼊发送时间。

{% asset_img 9.jpg %}

然后，由 ICMP 协议将这个数据包连同地址`192.168.1.2`⼀起交给 IP 层。IP 层将以`192.168.1.2`作为⽬的地址，本机 IP 地址作为源地址，协议字段设置为 1 表示是 ICMP 协议，再加上⼀些其他控制信息，构建⼀个 IP 数据包。

{% asset_img 10.jpg %}

接下来，需要加入 MAC 头。如果在本地 ARP 映射表中查找出 IP 地址`192.168.1.2`所对应的 MAC 地址，则可以直接使用；如果没有，则需要发送 ARP 协议查询 MAC 地址，获得 MAC 地址后，由数据链路层构建一个数据帧，目的地址是 IP 层传过来的 MAC 地址，源地址则是本机的 MAC 地址；还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。

{% asset_img 11.jpg %}

主机 B 收到这个数据帧后，先检查它的目的 MAC 地址，并和本机的 MAC 地址对比，如符合，则接收，否则就丢弃。

接收后检查该数据帧，将 IP 数据包从帧中提取出来，交给本机的 IP 层。同样，IP 层检查后，将有用的信息提取后交给 ICMP 协议。

主机 B 会构建一个 ICMP 回送响应消息数据包，回送响应数据包的类型字段为 0，序号为接收到的请求数据包中的序号，然后再发送出去给主机 A。

{% asset_img 12.jpg %}

在规定的时候间内，源主机如果没有接到 ICMP 的应答包，则说明目标主机不可达；如果接收到了 ICMP 回送响应消息，则说明目标主机可达。

此时，源主机会检查，用当前时刻减去该数据包最初从源主机上发出的时刻，就是 ICMP 数据包的时间延迟。

针对上面发送的事情，总结成了如下图：

{% asset_img 13.png %}

当然这只是最简单的，同⼀个局域⽹⾥⾯的情况。如果跨⽹段的话，还会涉及⽹关的转发、路由器的转发等等。

但是对于 ICMP 的头来讲，是没什么影响的。会影响的是根据⽬标 IP 地址，选择路由的下⼀跳，还有每经过⼀个路由器到达⼀个新的局域⽹，需要换 MAC 头⾥⾯的 MAC 地址。

说了这么多，可以看出 ping 这个程序是使⽤了 ICMP ⾥⾯的 ECHO REQUEST（类型为 8 ） 和 ECHO REPLY（类型为 0）。

