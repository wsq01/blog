

为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。

ICMP 是互联网的标准协议。但 ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议。

ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。

# ICMP 报文的格式 
{% asset_img img1.png %}
# ICMP 报文的种类
ICMP 报文的种类有两种，即 ICMP 差错报告报文和 ICMP 询问报文。 
ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即类型、代码和检验和。接着的 4 个字节的内容与 ICMP 的类型有关。最后面是数据字段，其长度取决于 ICMP 的类型。

ICMP 差错报告报文共有 4 种：
终点不可达 
时间超过 
参数问题 
改变路由（重定向）(Redirect) 

## ICMP 差错报告报文的数据字段的内容
所有的 ICMP 差错报告报文中的数据字段都具有同样的格式。把收到的需要进行差错报告的 IP 数据报的首部和数据字段的前8个字节提取出来，作为 ICMP 报文的数据字段。再加上相应的 ICMP 差错报告报文的前8个字节，就构成了 ICMP 差错报告报文。

{% asset_img img2.png %}

提取收到的数据报的数据字段前8个字节是为了得到运输层的端口号（对于 TCP 和 UDP）以及运输层报文的发送序号（对于 TCP）。这些信息对源点通知高层协议是有用的。

整个 ICMP 报文作为 IP 数据报的数据字段发送给源点。
## 不应发送 ICMP 差错报告报文的几种情况
* 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。
* 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
* 对具有多播地址的数据报都不发送 ICMP 差错报告报文。
* 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

ICMP 询问报文有两种：回送请求和回答报文、时间戳请求和回答报文。
下面的几种 ICMP 报文不再使用：信息请求与回答报文、掩码地址请求和回答报文、路由器询问和通告报文 、源点抑制报文。

# ICMP 的应用举例
PING (Packet InterNet Groper) 用来测试两个主机之间的连通性。
PING 使用了 ICMP 回送请求与回送回答报文。
PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。 

Traceroute 的应用举例
在 Windows 操作系统中这个命令是 tracert。
用来跟踪一个分组从源点到终点的路径。
它利用 IP 数据报中的 TTL 字段和 ICMP 时间超过差错报告报文实现对从源点到终点的路径的跟踪。
