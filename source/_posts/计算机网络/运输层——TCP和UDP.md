---
title: 运输层——TCP和UDP
date: 2020-10-13 17:21:43
tags: 计算机网络
categories: 计算机网络
---


# 运输层协议概述
## 进程之间的通信
从通信和信息处理的角度看，运输层向它上面的应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最低层。

当网络的边缘部分中的两个主机使用网络的核心部分的功能进行端到端的通信时，只有位于网络边缘部分的主机的协议栈才有运输层，而网络核心部分中的路由器在转发分组时都只用到下三层的功能。 
### 端系统之间通信的含义
从IP层来说，通信的两端是两台主机。IP 数据报的首部明确的标志了这两台主机的 IP 地址。但“两台主机之间的通信”这种说法还不够清楚。IP 协议虽然能把分组送到目的主机，但是这个分组还停留在主机的网络层而没有交付主机中的应用进程。

从运输层的角度看，通信的真正端点并不是主机而是主机中的进程。也就是说，端到端的通信是应用进程之间的通信。

“主机A和主机B进行通信”实际上是指：“运行在主机A上的某个程序和运行在主机B上的另一个程序进行通信”。即“主机 A 的某个进程和主机 B 上的另一个进程进行通信”。简称为“计算机之间通信”。

在一台主机中经常有多个应用进程同时分别和另一台主机中的多个应用进程通信。
### 网络层和运输层的区别
网络层是为主机之间提供逻辑通信；运输层为应用进程之间提供端到端的逻辑通信。

{% asset_img img2.png %}

上图中，主机 A 的应用进程 AP<sub>1</sub> 和主机 B 的应用进程 AP<sub>3</sub> 通信，应用进程 AP<sub>2</sub> 和应用进程 AP<sub>4</sub> 通信。
### 基于端口的复用和分用功能
运输层有一个很重要的功能：复用和分用。复用是指在发送方不同的应用进程都可以使用同一个运输层协议传送数据；分用是指接收方的运输层在剥去报文的首部后能够把这些数据正确交付目的应用进程。

{% asset_img img3.png %}

### 两种不同的运输协议
运输层向高层用户屏蔽了下面网络核心的细节，它使应用进程看见的就是好像在两个运输层实体之间有一条端到端的逻辑通信信道。但这条逻辑通信信道对上层的表现却因运输层使用的不同协议而有很大的差别。

当运输层采用面向连接的 TCP 协议时，尽管下面的网络是不可靠的（只提供尽最大努力服务），但这种逻辑通信信道就相当于一条全双工的可靠信道。

当运输层采用无连接的 UDP 协议时，这种逻辑通信信道是一条不可靠信道。 

{% asset_img img4.png %}

## 运输层的两个主要协议
TCP/IP 的运输层有两个主要协议：
* 用户数据报协议 UDP(`User Datagram Protocol`)
* 传输控制协议 TCP(`Transmission Control Protocol`)

{% asset_img img5.png %}

### TCP 与 UDP
两个对等运输实体在通信时传送的数据单位叫作运输协议数据单元 TPDU(`Transport Protocol Data Unit`)。
* TCP 传送的数据单位协议是 TCP 报文段。
* UDP 传送的数据单位协议是 UDP 报文或用户数据报。 

{% asset_img img6.png %}

### 使用 UDP 和 TCP 的典型应用和应用层协议

{% asset_img img7.png %}

还要强调两点：
* 运输层的 UDP 用户数据报与网际层的IP数据报有很大区别。
IP 数据报要经过互连网中许多路由器的存储转发。
UDP 用户数据报是在运输层的端到端抽象的逻辑信道中传送的。
* TCP 报文段是在运输层抽象的端到端逻辑信道中传送，这种信道是可靠的全双工信道。但这样的信道却不知道究竟经过了哪些路由器，而这些路由器也根本不知道上面的运输层是否建立了 TCP 连接。

## 运输层的端口
运行在计算机中的进程是用进程标识符来标志的。

但运行在应用层的各种应用进程却不应当让计算机操作系统指派它的进程标识符。这是因为在互联网上使用的计算机的操作系统种类很多，而不同的操作系统又使用不同格式的进程标识符。

为了使运行不同操作系统的计算机的应用进程能够互相通信，就必须用统一的方法对 TCP/IP 体系的应用进程进行标志。

{% asset_img img8.png %}

由于进程的创建和撤销都是动态的，发送方几乎无法识别其他机器上的进程。

有时我们会改换接收报文的进程，但并不需要通知所有发送方。

我们往往需要利用目的主机提供的功能来识别终点，而不需要知道实现这个功能的进程。

解决这个问题的方法就是在运输层使用协议端口号(`protocol port number`)，或通常简称为端口(`port`)。

虽然通信的终点是应用进程，但我们可以把端口想象是通信的终点，因为我们只要把要传送的报文交到目的主机的某一个合适的目的端口，剩下的工作（即最后交付目的进程）就由 TCP 来完成。
### 软件端口与硬件端口
在协议栈层间的抽象的协议端口是软件端口。

路由器或交换机上的端口是硬件端口。

硬件端口是不同硬件设备进行交互的接口，而软件端口是应用层的各种协议进程与运输实体进行层间交互的一种地址。 
### TCP/IP 运输层端口
端口用一个 16 位端口号进行标志，允许有 65535 个不同的端口号。

端口号只具有本地意义，即端口号只是为了标志本计算机应用层中的各进程。在互联网中，不同计算机的相同端口号是没有联系的。

{% asset_img img9.png %}

由此可见，两个计算机中的进程要互相通信，不仅必须知道对方的端口号（为了找到对方计算机中的应用进程） ，而且还要知道对方的 IP 地址（为了找到对方的计算机）。
### 两大类端口
计算机通信是采用客户——服务器方式，客户在发起通信请求时，必须先知道对方服务器的 IP 地址和端口号。因此运输层的端口号分为两大类：
1. 服务器端使用的端口号，又分为两类：
 * 熟知端口，数值一般为 0 ~ 1023。
 * 登记端口号，数值为 1024 ~ 49151，为没有熟知端口号的应用程序使用的。使用这个范围的端口号必须在 IANA 登记，以防止重复。
2. 客户端使用的端口号，又称为短暂端口号，数值为 49152 ~ 65535，留给客户进程选择暂时使用。
当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可供其他客户进程以后使用。 

{% asset_img img10.png %}

### 常用的熟知端口

{% asset_img img11.png %}

# 用户数据报协议 UDP
## UDP 概述
UDP 只在 IP 的数据报服务之上增加了很少一点的功能：复用和分用的功能、差错检测的功能。

{% asset_img img12.png %}

### UDP 的主要特点
* UDP 是无连接的，发送数据之前不需要建立连接，因此减少了开销和发送数据之前的时延。
* UDP 使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表。
* UDP 是面向报文的。
* UDP 没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。很适合多媒体通信的要求。 
* UDP 支持一对一、一对多、多对一和多对多的交互通信。
* UDP 的首部开销小，只有 8 个字节，比 TCP 的 20 个字节的首部要短。

### 面向报文的 UDP
发送方 UDP 对应用程序交下来的报文，在添加首部后就向下交付 IP 层。UDP 对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。

应用层交给 UDP 多长的报文，UDP 就照样发送，即一次发送一个报文。

接收方 UDP 对 IP 层交上来的 UDP 用户数据报，在去除首部后就原封不动地交付上层的应用进程，一次交付一个完整的报文。

应用程序必须选择合适大小的报文。

若报文太长，UDP 把它交给 IP 层后，IP 层在传送时可能要进行分片，这会降低 IP 层的效率。

若报文太短，UDP 把它交给 IP 层后，会使 IP 数据报的首部的相对长度太大，这也降低了 IP 层的效率。

{% asset_img img13.png %}
{% asset_img img14.png %}

## UDP 的首部格式
用户数据报 UDP 有两个字段：数据字段和首部字段。

首部字段有 8 个字节，由 4 个字段组成，每个字段都是 2 个字节。

{% asset_img img15.png %}

### UDP 基于端口的分用
当运输层从 IP 层收到 UDP 数据报时，就根据首部中的目的端口，把 UDP 数据报通过相应的端口，上交给最后的终点——应用进程。

请注意，虽然在 UDP 之间的通信要用到端口号，但由于 UDP 的通信是无连接的，因此不需要使用套接字来建立连接。

{% asset_img img16.png %}
{% asset_img img17.png %}

计算检验和时，临时把 12 字节的“伪首部”和 UDP 用户数据报连接在一起。伪首部仅仅是为了计算检验和。
### 计算 UDP 检验和的例子

{% asset_img img18.png %}

# 传输控制协议 TCP 概述
## TCP 最主要的特点

{% asset_img img19.png %}

* TCP 是面向连接的运输层协议。
* 每一条 TCP 连接只能有两个端点，每一条 TCP 连接只能是点对点的（一对一）。 
* TCP 提供可靠交付的服务。
* TCP 提供全双工通信。
* 面向字节流。

TCP 中的“流”指的是流入或流出进程的字节序列。

“面向字节流”的含义是：虽然应用程序和 TCP 的交互是一次一个数据块，但 TCP 把应用程序交下来的数据看成仅仅是一连串无结构的字节流。
### TCP 面向流的概念
TCP 不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系。

但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样。

{% asset_img img20.png %}
{% asset_img img21.png %}

TCP 连接是一条虚连接而不是一条真正的物理连接。

TCP 对应用进程一次把多长的报文发送到 TCP 的缓存中是不关心的。

TCP 根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）。

TCP 可把太长的数据块划分短一些再传送。

TCP 也可等待积累有足够多的字节后再构成报文段发送出去。
## TCP 的连接
TCP 把连接作为最基本的抽象。每一条 TCP 连接有两个端点。

TCP 连接的端点不是主机，不是主机的 IP 地址，不是应用进程，也不是运输层的协议端口。TCP 连接的端点叫做套接字(`socket`)或插口。

端口号拼接到 IP 地址即构成了套接字。 

{% asset_img img22.png %}

### 套接字 (socket)
套接字`socket = (IP地址 : 端口号)`

每一条 TCP 连接唯一地被通信两端的两个端点（即两个套接字）所确定。即：
```
TCP 连接 ::= {socket1, socket2} = {(IP1: port1)，(IP2: port2)}
```
### TCP 连接，IP 地址，套接字
TCP 连接就是由协议软件所提供的一种抽象。

TCP 连接的端点是个很抽象的套接字，即（IP 地址：端口号）。

同一个 IP 地址可以有多个不同的 TCP 连接。

同一个端口号也可以出现在多个不同的 TCP 连接中。 

## TCP 报文段的首部格式
TCP 虽然是面向字节流的，但 TCP 传送的数据单元却是报文段。

一个 TCP 报文段分为首部和数据两部分，而 TCP 的全部功能都体现在它首部中各字段的作用。

TCP 报文段首部的前 20 个字节是固定的，后面有`4n`字节是根据需要而增加的选项 (`n`是整数)。因此 TCP 首部的最小长度是 20 字节。

{% asset_img img33.png %}

### 首部固定部分各字段含义
* 源端口和目的端口字段——各占 2 字节。端口是运输层与应用层的服务接口。运输层的复用和分用功能都要通过端口才能实现。
* 序号字段——占 4 字节。TCP 连接中传送的数据流中的每一个字节都编上一个序号。序号字段的值则指的是本报文段所发送的数据的第一个字节的序号。 
* 确认号字段——占 4 字节，是期望收到对方的下一个报文段的数据的第一个字节的序号。
* 数据偏移（即首部长度）——占 4 位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。“数据偏移”的单位是 32 位字（以 4 字节为计算单位）。 
* 保留字段——占 6 位，保留为今后使用，但目前应置为 0。 
* 紧急 URG —— 当`URG = 1`时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)。
* 确认 ACK —— 只有当`ACK =1`时确认号字段才有效。当`ACK = 0`时，确认号无效。
* 推送 PSH —— 接收 TCP 收到`PSH = 1`的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付。
* 复位 RST —— 当`RST=1`时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。
* 同步 SYN —— 同步`SYN = 1`表示这是一个连接请求或连接接受报文。 
* 终止 FIN —— 用来释放一个连接。`FIN = 1`表明此报文段的发送端的数据已发送完毕，并要求释放运输连接。 
* 窗口字段 —— 占 2 字节，用来让对方设置发送窗口的依据，单位为字节。
* 检验和 —— 占 2 字节。检验和字段检验的范围包括首部和数据这两部分。在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。
在计算检验和时，临时把 12 字节的“伪首部”和 TCP 报文段连接在一起。伪首部仅仅是为了计算检验和。
* 紧急指针字段 —— 占 16 位，指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）。 
* 选项字段 —— 长度可变。TCP 最初只规定了一种选项，即最大报文段长度 MSS。MSS 告诉对方 TCP：“我的缓存所能接收的报文段的数据字段的最大长度是 MSS 个字节。” 
* 填充字段 —— 这是为了使整个首部长度是 4 字节的整数倍。

MSS(`Maximum Segment Size`)是 TCP 报文段中的数据字段的最大长度。

数据字段加上 TCP 首部才等于整个的 TCP 报文段。

所以，MSS是“TCP 报文段长度减去 TCP 首部长度”。

### 为什么要规定 MSS?
MSS 与接收窗口值没有关系。

若选择较小的 MSS 长度，网络的利用率就降低。

若 TCP 报文段非常长，那么在 IP 层传输时就有可能要分解成多个短数据报片。在终点要把收到的各个短数据报片装配成原来的 TCP 报文段。当传输出错时还要进行重传。这些也都会使开销增大。

因此，MSS 应尽可能大些，只要在 IP 层传输时不需要再分片就行。但最佳的 MSS 是很难确定的。
### 选项字段的其他选项
* 窗口扩大选项 ——占 3 字节，其中有一个字节表示移位值`S`。新的窗口值等于 TCP 首部中的窗口位数增大到`16 + S`，相当于把窗口值向左移动`S`位后获得实际的窗口大小。
* 时间戳选项——占 10 字节，其中最主要的字段时间戳值字段（4 字节）和时间戳回送回答字段（4 字节）。
* 选择确认选项。 

