


# 运输层协议概述
## 进程之间的通信
从通信和信息处理的角度看，运输层向它上面的应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最低层。

当网络的边缘部分中的两个主机使用网络的核心部分的功能进行端到端的通信时，只有位于网络边缘部分的主机的协议栈才有运输层，而网络核心部分中的路由器在转发分组时都只用到下三层的功能。 

设局域网1上的主机 A 和局域网2上的主机 B 通过互连的广域网进行通信。

{% asset_img img1.png 运输层为相互通信的应用进程提供了逻辑通信 %}

两个主机进行通信实际上就是两个主机中的应用进程互相通信。应用进程之间的通信又称为端到端的通信。

运输层的一个很重要的功能就是复用和分用。应用层不同进程的报文通过不同的端口向下交到运输层，再往下就共用网络层提供的服务。复用是指在发送方不同的应用进程都可以使用同一个运输层协议传送数据，分用是指接收方的运输层在剥去报文的首部后，能够把这些数据正确交付到目的应用进程。

“运输层提供应用进程间的逻辑通信”。“逻辑通信”的意思是：运输层之间的通信好像是沿水平方向传送数据。但事实上这两个运输层之间并没有一条水平方向的物理连接。要传送的数据是沿着图中的虚线方向传送的。
### 运输层协议和网络层协议的主要区别 

{% asset_img img2.png 运输层协议和网络层协议的主要区别  %}

网络层为主机之间提供逻辑通信，运输层为应用程序之间提供端到端的逻辑通信。
运输层还要对收到的报文进行差错检测。在网络层，IP 数据报首部中低端校验和字段只检验首部是否出现差错而不检查数据部分。
## 运输层的两个主要协议
TCP/IP 的运输层有两个不同的协议：
* 用户数据报协议 UDP(User Datagram Protocol)
* 传输控制协议 TCP(Transmission Control Protocol)

两种协议在协议栈中的位置：

{% asset_img img3.png TCP/IP 体系中的运输层协议  %}

两个对等运输实体在通信时传送的数据单位叫作运输协议数据单元 TPDU (Transport Protocol Data Unit)。
* TCP 传送的数据单位协议是 TCP 报文段(`segment`)。
* UDP 传送的数据单位协议是 UDP 用户数据报。 

UDP 在传送数据之前不需要先建立连接。对方的运输层在收到 UDP 报文后，不需要给出任何确认。虽然 UDP 不提供可靠交付，但在某种情况下 UDP 却是一种有效的工作方式。

TCP 则提供面向连接的服务。在传送数据之前必须先建立连接，数据传送结束后要释放连接。TCP 不提供广播或多播服务。由于 TCP 要提供可靠的、面向连接的运输服务，因此不可避免的增加了许多开销，如确认、流量控制、计时器等。

一些应用和应用层协议主要使用的运输层协议：

| 应用 | 应用层协议 | 运输层协议 |
| :--: | :--: | :--: |
| 名字转换 | DNS | UDP |
| 文件传送 | TFTP | UDP |
| 路由选择协议 | RIP | UDP |
| IP 地址分配 | BOOTP,DHCP | UDP |
| 网络管理 | SNMP | UDP |
| 远程文件服务器 | NFS | UDP |
| IP 电话 | 专用协议 | UDP |
| 流式多媒体通信 | 专用协议 | UDP |
| 多播 | IGMP | UDP |
| 电子邮件 | SMTP | TCP |
| 远程终端接入 | TELNET | TCP |
| 万维网 | HTTP | TCP |
| 文件传送 | FTP | TCP |

## 运输层的端口
运行在计算机中的进程是用进程标识符来标志的。

运行在应用层的各种应用进程却不应当让计算机操作系统指派它的进程标识符。这是因为在因特网上使用的计算机的操作系统种类很多，而不同的操作系统又使用不同格式的进程标识符。

为了使运行不同操作系统的计算机的应用进程能够互相通信，就必须用统一的方法对 TCP/IP 体系的应用进程进行标志。 

# 用户数据报协议UDP
## UDP概述
UDP 的主要特点：
* UDP 是无连接的，即发送数据之前不需要建立连接。
* UDP 使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表。
* UDP 是面向报文的。
发送方的 UDP 对应用程序交下来的报文在添加首部后就向下交付给 IP 层。
UDP 对应用层交下来的报文既不合并也不拆分，而是保留这些报文的边界。这就是说应用层交付给 UDP 多长的报文，UDP 就照样发送，即一次发送一个报文。
在接收方的 UDP，对 IP 层交上来的 UDP 用户数据报，在除去首部后就原封不动的交付给上层的应用进程。也就是说 UDP 一次交付一个完整的报文。
* UDP 没有拥塞控制，因此网络出现的拥塞不会使源主机的发送速率降低。
* UDP 支持一对一、一对多、多对一和多对多的交互通信。
* UDP 的首部开销小，只有8个字节。

## UDP的首部格式
用户数据报 UDP 有两个字段：数据字段和首部字段。首部字段只有8个字节，由4个字段组成，每个字段的长度都是两个字节。各字段意义如下：
1. 源端口：源端口号，在需要对方回信时选用，不需要时可用全0。
2. 目的端口：目的端口号，这在终点交付报文时必须要使用到。
3. 长度：UDP 用户数据报的长度，最小值是8（仅有首部）。
4. 校验和：检测 UDP 用户数据报在在传输中是否有错。有错就丢弃。

# 传输控制协议TCP概述
## TCP最主要的特点
* TCP 是面向连接的运输层协议。这就是说，应用程序在使用 TCP 协议之前，必须先建立 TCP 连接。在传输完毕后，必须释放已经建立的 TCP 连接。
* 每一条 TCP 连接只能有两个端点，每一条 TCP 连接只能是点对点的（一对一）。
* TCP 提供可靠交付的服务。也就是说，通过 TCP 连接传送的数据，无差错、不丢失、不重复、并且按序到达。
* TCP 提供全双工通信。TCP 允许通信双方的应用进程在任何时候都能发送数据。TCP 连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的数据。在发送时，应用程序在把数据传送给 TCP 的缓存后，就可以做自己的事，而 TCP 在合适的时候把数据发送出去。在接收时，TCP 把收到的数据放入缓存，上层的应用进程在合适的时候读取缓存中的数据。
* 面向字节流。

## TCP的连接
每一条 TCP 连接有两个端点，TCP 连接的端点叫套接字或插口。端口号拼接到 IP 地址即构成了套接字。

套接字socket = IP 地址:端口号

每一条 TCP 连接唯一的被通信两端的两个端点（即两个套接字）所确定。

同一个 IP 地址可以有多个不同的 TCP 连接，同一个端口号也可以出现在多个不同的 TCP 连接中。
# 可靠传输的工作原理
TCP 发送的报文是交给 IP 层传送的，但 IP 层只能提供尽最大努力服务，也就是说，TCP 下面的网络所提供的是不可靠的传输。因此，TCP 必须采用适当的措施才能使得两个运输层之间的通信变得可靠。

## 停止等待协议
## 连续ARQ协议

{% asset_img img6.png %}

图中(a)表示发送方维持的发送窗口，它的意义是：位于发送窗口内的5个分组都可连续发送出去，而不需要等待对方的确认。这样，信道利用率就提高了。

连续 ARQ 协议规定，发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置。图(b)表示发送方收到了对第一个分组的确认，于是把发送窗口向前移动一个分组的位置。
### 累积确认
接收方一般采用累积确认的方式。接收方不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了。

累积确认有的优点是：容易实现，即使确认丢失也不必重传。缺点是：不能向发送方反映出接收方已经正确收到的所有分组的信息。
#### Go-back-N（回退 N）
如果发送方发送了前 5 个分组，而中间的第 3 个分组丢失了。这时接收方只能对前两个分组发出确认。发送方无法知道后面三个分组的下落，而只好把后面的三个分组都再重传一次。

这就叫做 Go-back-N（回退 N），表示需要再退回来重传已发送过的 N 个分组。

可见当通信线路质量不好时，连续 ARQ 协议会带来负面的影响。 
# TCP报文段的首部格式
TCP 虽然是面向字节流的，但 TCP 传送的数据单元却是报文段。一个 TCP 报文段分为首部和数据两部分，TCP 的全部功能都体现在它首部中各字段的作用。

{% asset_img img7.png %}

TCP 报文段首部的前20个字节是固定的，后面有4n字节是根据需要而增加的选项。因此 TCP 首部的最小长度是20个字节。
首部固定部分各字段意义如下：
1. 源端口和目的端口：各占2个字节。端口是运输层与应用层的服务接口。运输层的复用和分用功能都要通过端口才能实现。
2. 序号：占4个字节，TCP 连接中传送的数据流中的每一个字节都编上一个序号。序号字段的值则指的是本报文段所发送的数据的第一个字节的序号。
3. 确认号：占4个字节，是期望收到对方下一个报文段的第一个数据字节的序号。
4. 数据偏移：占4位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。实际上是指出 TCP 报文段的首部长度。由于首部中还有长度不确定的选项字段，因此数据偏移字段是必要的。“数据偏移”的单位是 32 位字（以 4 字节为计算单位）。由于4位二进制数能表示的最大十进制数字是15，因此数据偏移的最大值是60字节，这也是 TCP 首部的最大长度（即选项长度不能超过40字节）。
5. 保留：占6位，保留为今后使用，目前应置为0。
6. 紧急 URG（URGent）：当 URG = 1时，表示紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送（相当于高优先级的数据），而不要按原来的排队顺序来传送。
7. 确认 ACK（ACKnowlegment）：仅当 ACK = 1时确认号字段才有效。当 ACK = 0时，确认号无效。
8. 推送 PSH：当两个应用进程进行通信时，有时在一端的应用进程希望在键入一个命令后立即就能收到对方的响应。在这种情况下，TCP 就可以使用推送操作。这时，发送方 TCP 把 PSH 置1，并立即创建一个报文段发送出去，接收方 TCP 收到`PSH = 1`的报文段，就尽快的交付给接收应用进程，而不再等到整个缓存都填满了后再向上交付。
9. 复位 RST：当`RST = 1`时，表明 TCP 连接中出现严重差错，必须释放连接，然后再重新建立运输连接。`RST = 1`还用来拒绝一个非法的报文段或拒绝打开一个连接。
10. 同步 SYN（SYNchronization）：在连接建立时用来同步序号。当`SYN = 1, ACK = 0`时，表明这是一个连接请求报文段。对方若同意建立连接，则应该在响应的报文段中使`SYN = 1, ACK = 1`。因此`SYN = 1`表示这是一个连接请求或连接接受报文。
11. 终止 FIN：用来释放一个连接。当`FIN = 1`时，表明此报文段的发送方的数据已发送完毕，并要求释放运输连接。
12. 窗口：占2个字节，用来让对方设置发送窗口的依据，单位为字节。
13. 校验和：占2个字节，检验和字段检验的范围包括首部和数据这两部分。在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。
14. 紧急指针： 占2个字节，指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）。  
15. 选项：长度可变，最长可达40字节

# TCP可靠传输的实现
# TCP的流量控制
## 利用滑动窗口实现流量控制
一般我们希望数据传输的更快一些，但如果发送方把数据发送的过快，接收方就可能来不及接收，就会造成数据丢失。

所谓流量控制就是让发送方的发送速率不要太快，要让接收方来得及接收。

利用滑动窗口机制可以很方便的在 TCP 连接上实现对发送方的流量控制。

{% asset_img img9.png %}

设 A 向 B 发送数据。在连接建立时，B 告诉了 A：“我的接收窗口 rwnd（receiver window） = 400（字节）”。因此发送方的发送窗口不能超过接收方给出的接收窗口的数值。TCP 的窗口单位是字节，不是报文段。

再设每一个报文段为100个字节，而数据报文段序号的初始值为1（`seq = 1`），ACK 表示首部中的确认位 ACK，小写 ack 表示确认字段的值。

现在我们考虑一种情况。B 向 A 发送了零窗口的报文段后不久，B 的接收缓存又有了一些存储空间。于是 B 向 A 发送了`rwnd = 400`的报文段。然而这个报文段在传送过程中丢失了，A 一直等待收到 B 发送的非零窗口的通知，而 B 也一直等待 A 发送的数据。如果没有其他措施，这种互相等待的死锁局面就会一直延续。

为了解决这个问题，TCP 为每一个连接设有一个持续计时器。只要 TCP 连接的一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发送一个零窗口探测报文段（仅携带 1 字节的数据），而对方就在确认这个探测报文段时给出了现在的窗口值。若窗口仍然是零，则收到这个报文段的一方就重新设置持续计时器。若窗口不是零，则死锁的僵局就可以打破了。
## 必须考虑传输效率
# TCP的拥塞控制
## 拥塞控制的一般原理
## 几种拥塞控制方法
## 随机早期检测RED
# TCP的运输连接管理
TCP 连接的建立采用客户服务器方式。主动发起连接建立的应用进程叫做客户，被动等待建立连接的应用进程叫服务器。
## TCP的连接建立

{% asset_img img10.png 用三次握手建立 TCP 连接的各状态 %}

假定主机 A 运行的是 TCP 客户程序，B 运行 TCP 服务器程序。最初两端的 TCP 进程都处于 CLOSED（关闭） 状态。图中在主机下面的方框分别是 TCP 进程所处的状态。注意，A 主动打开连接，B 被动打开连接。

B 的 TCP 服务器进程先创建传输控制块 TCB，准备接受客户进程的连接请求。然后服务器进程就处于 LISTEN（收听）状态，等待客户的连接请求。

A 的 TCP 客户进程也是首先创建传输控制块 TCB，然后向 B 发出连接请求报文段，这时，首部中的同部位 SYN = 1，同时选择一个初始序号`seq = x`。TCP 规定 SYN 报文段（即 SYN = 1的报文段）不能携带数据，但要消耗掉一个序号。这时，TCP 客户进程进入 SYN-SENT（同步已发送）状态。

B 收到连接请求报文段后，如同意建立连接，则向 A 发送确认。在确认报文段中，SYN = 1, ACK = 1，确认号是`ack = x + 1`，同时也为自己选择一个初始序号 seq = y。这个报文段也不能携带数据，但同样要消耗掉一个序号。这时，TCP 服务器进程进入 SYN-RCVD（同步收到）状态。

TCP 客户进程收到 B 的确认后，还要向 B 给出确认。`ACK = 1, ack = y + 1`，而自己的序号`seq = x + 1`。TCP 规定，ACK报文段可以携带数据。但如果不携带数据则不消耗序号，在这种情况下，下一个数据报文段的序号仍是`seq = x + 1`。这时 TCP 连接已经建立，A 进入 ESTABLISHED（已建立连接）状态。

当 B 收到 A 的确认后，也进入 ESTABLISHED 状态。

为什么 A 还要发一次确认呢？这主要是为了防止已失效的连接请求报文段突然又传送到了 B，因而产生错误。

所谓已失效的连接请求报文是这样产生的。考虑一种正常情况，A 发出连接请求，但因连接请求报文丢失而未收到确认。于是 A 再重传一次连接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接。A 共发了两个连接请求报文段。其中第一个丢失，第二个到达 B。没有“已失效的连接请求报文段”。

现假定出现一种异常情况，即 A 发出的第一个连接请求报文段并没有丢失，而是在某些网络节点长时间滞留了，以致延误到连接释放后的某个时间才到达 B。本来这是一个早已失效的报文段。但 B 收到此失效的连接请求报文段后，就误认为是 A 又发出一次新的连接请求。于是就向 A 发出确认报文段，同意建立连接。假定不采用三次握手，那么只要 B 发出确认，新的连接就建立了。由于现在 A 并没有发出建立连接请求，因此不会理睬 B 的确认，也不会向 B 发送数据。但 B 却以为新的运输连接已经建立了，并一直等待 A 发来数据，B 的许多资源就这样白白浪费了。

采用三次握手就可以防止上述现象的发生。例如在刚才的情况下，A 不会向 B 的确认发出确认，B 收不到确认就知道 A 并没有要求建立连接。
## TCP的连接释放

{% asset_img img12.png TCP 连接释放的过程 %}
数据传输结束后，通信的双方都可释放连接。现在 A 和 B 都处于 ESTABLISHED 状态。A 的应用进程先向其 TCP 发出连接释放报文段，并停止再发送数据，主动关闭 TCP 连接。A 把连接释放报文段首部的 FIN 置1，其序号`seq = u`，它等于前面已传送过的数据的最后一个字节的序号加1。这时 A 进入 FIN-WAIT-1（终止等待1）状态，等待 B 的确认。TCP 规定，FIN 报文段即使不携带数据也消耗掉一个序号。

B 收到连接释放报文段后立即发出确认，确认号是`ack = u + 1`，而这个报文段自己的序号是`v`，等于 B 前面已传送过的数据的最后一个字节的序号加1。然后 B 进入 CLOSE-WAIT（关闭等待）状态。TCP 服务器进程这时应通知高层应用进程，因而从 A 到 B 这个方向的连接就释放了，这时的 TCP 连接处于半关闭状态，即 A 已经没有数据要发送了，但 B 若发送数据，A 仍要接收。也就是说，从 B 到 A 这个方向的连接并未关闭。这个状态可能会持续一些时间。

A 收到来自 B 的确认后，就进入 FIN-WAIT-2（终止等待2）状态，等待 B 发出的连接释放报文段。

若 B 已经没有要向 A 发送的数据，其应用进程就通知 TCP 释放连接。这时 B 发出的连接释放报文段必须使 FIN = 1。现假定 B 的序号为`w`（半关闭状态 B 可能又发送了一些数据）。B 还必须重复上次已发送过的确认号`ack = u + 1`。这时 B 就进入 LAST-ACK（最后确认）状态，等待 A 的确认。

A 在收到 B 的连接释放报文段后，必须对此发出确认。在确认报文段中，`ACK = 1, ack = w + 1`，而自己的序号是`seq = u + 1`。然后进入到 TIME-WAIT（时间等待）状态。现在 TCP 连接还没有释放掉。必须经过时间等待计时器设置的时间 2MSL 后，A 才进入到 CLOSED 状态。时间 MSL 叫最长报文段寿命（Maximum Segment Lifetime）。当 A 撤销相应的传输控制块 TCB 后，就结束了这次 TCP 连接。

B 只要收到了 A 的确认，就进入 CLOSED 状态。同样，B 在撤销相应的传输控制块 TCB 后，就结束了这次的 TCP 连接。B 结束 TCP 连接的时间要比 A 早。
## TCP的有限状态机
TCP 连接的各种状态之间的关系如下图。

图中每一个方框都是 TCP 可能具有的状态。

每个方框中的大写英文字符串是 TCP 标准所使用的 TCP 连接状态名。状态之间的箭头表示可能发生的状态变迁。

箭头旁边的字，表明引起这种变迁的原因，或表明发生状态变迁后又出现什么动作。

图中有三种不同的箭头。
* 粗实线箭头表示对客户进程的正常变迁。
* 粗虚线箭头表示对服务器进程的正常变迁。
* 另一种细线箭头表示异常变迁。 

{% asset_img img13.png TCP 的有限状态机 %}

