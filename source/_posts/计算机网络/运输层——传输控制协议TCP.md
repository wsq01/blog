---
title: 传输层——传输控制协议TCP
date: 2020-10-13 16:36:43
tags: 计算机网络
categories: 计算机网络
---


# TCP 最主要的特点

{% asset_img img19.png %}

* TCP 是面向连接的运输层协议。
* 每一条 TCP 连接只能有两个端点，每一条 TCP 连接只能是点对点的（一对一）。 
* TCP 提供可靠交付的服务。通过TCP连接传送的数据，无差错、不丢失、不重复， 并且按序到达。
* TCP 提供全双工通信。
* 面向字节流。

全双工通信是指 TCP 允许通信双方的应用进程在任何时候都能发送数据。TCP 连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的数据。在发送时，应用程序在把数据传送给TCP的缓存后，就可以做自己的事，而 TCP 在合适的时候把数据发送出去。在接收时，TCP 把收到的数据放入缓存，上层的应用进程在合适的时候读取缓存中的数据。

“面向字节流”的含义是：虽然应用程序和 TCP 的交互是一次一个数据块，但 TCP 把应用程序交下来的数据看成仅仅是一连串无结构的字节流。
## TCP 面向流的概念
TCP 中的“流”指的是流入或流出进程的字节序列。

“面向字节流”的含义是：虽然应用程序和 TCP 的交互是一次一个数据块(大小不等)，但 TCP 把应用程序交下来的数据仅仅看成是一连串的无结构的字节流。TCP 并不知道所传送的字节流的含义。TCP 不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系(例如，发送方应用程序交给发送方的 TCP 共 10 个数据块，但接收方的 TCP 可能只用了 4 个数据块就把收到的字节流交付上层的应用程序)。但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样。当然，接收方的应用程序必须有能力识别收到的字节流，把它还原成有意义的应用层数据。

{% asset_img img20.png %}
<br>
{% asset_img img21.png %}

TCP 连接是一条虚连接而不是一条真正的物理连接。

TCP 对应用进程一次把多长的报文发送到 TCP 的缓存中是不关心的。

TCP 根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）。

TCP 可把太长的数据块划分短一些再传送。

TCP 也可等待积累有足够多的字节后再构成报文段发送出去。
# TCP 的连接
TCP 把连接作为最基本的抽象。每一条 TCP 连接有两个端点。

TCP 连接的端点不是主机，不是主机的 IP 地址，不是应用进程，也不是运输层的协议端口。TCP 连接的端点叫做套接字(`socket`)。 

{% asset_img img22.png %}

端口号拼接到 IP 地址即构成了套接字。套接字`socket = (IP地址:端口号)`
## TCP 连接，IP 地址，套接字
TCP 连接就是由协议软件所提供的一种抽象。

TCP 连接的端点是个很抽象的套接字，即（IP 地址:端口号）。

同一个 IP 地址可以有多个不同的 TCP 连接。

同一个端口号也可以出现在多个不同的 TCP 连接中。
# TCP 报文段的首部格式
TCP 虽然是面向字节流的，但 TCP 传送的数据单元却是报文段。

一个 TCP 报文段分为首部和数据两部分，TCP 的全部功能都体现在它首部中各字段的作用。

TCP 报文段首部的前 20 个字节是固定的，后面有`4n`字节是根据需要而增加的选项 (`n`是整数)。因此 TCP 首部的最小长度是 20 字节。

{% asset_img img33.png %}

## 首部固定部分各字段含义
* 源端口和目的端口：各占 2 字节。端口是运输层与应用层的服务接口。运输层的复用和分用功能都要通过端口才能实现。
* 序号：占 4 字节。TCP 连接中传送的数据流中的每一个字节都编上一个序号。序号字段的值则指的是本报文段所发送的数据的第一个字节的序号。序号增加到2<sup>32</sup>-1后，下一个序号就又回到 0。也就是说，序号使用mod 2<sup>32</sup>运算。在一个 TCP 连接中传送的字节流中的每一个字节都按顺序编号。整个要传送的字节流的起始序号必须在连接建立时设置。
* 确认号：占 4 字节，是期望收到对方的下一个报文段的数据的第一个字节的序号。
* 数据偏移（即首部长度）——占 4 位，它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。由于首部中还有长度不确定的选项字段，因此数据偏移字段是必要的。“数据偏移”的单位是 32 位字（以 4 字节为计算单位）。由于 4 位二进制数能够表示的最大十进制数字是 15，因此数据偏移的最大值是 60 字节，这也是 TCP 首部的最大长度(即选项长度不能超过 40 字节)。
* 保留字段：占 6 位，保留为今后使用，但目前应置为 0。 
* 紧急 URG (`URGent`)：当`URG = 1`时，表明紧急指针字段有效。它告诉系统此报文段中有紧急数据，应尽快传送(相当于高优先级的数据)。当`URG = 1`时，发送应用进程就告诉发送方的 TCP 有紧急数据要传送。于是发送方 TCP 就把紧急数据插入到本报文段数据的最前面，而在紧急数据后面的数据仍是普通数据。这时要与首部中紧急指针字段配合使用。
* 确认 ACK(`ACKnowledgment`)：只有当`ACK =1`时确认号字段才有效。当`ACK = 0`时，确认号无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。
* 推送 PSH(`PuSH`) ：当两个应用进程进行交互式的通信时，有时在一端的应用进程 希望在键入一个命令后立即就能够收到对方的响应。在这种情况下，TCP 就可以使用推送操作。这时，发送方 TCP 把 PSH 置 1,并立即创建一个报文段发送出去。接收方 TCP 收到`PSH = 1`的报文段，就尽快地交付接收应用进程，而不再等到整个缓存都填满了后再向上交付。虽然应用程序可以选择推送操作，但推送操作很少使用。
* 复位 RST(`ReSeT`) —— 当`RST=1`时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），必须释放连接，然后再重新建立运输连接。RST 置 1 还用来拒绝一个非法的报文段或拒绝打开一个连接。RST 也可称为重建位或重置位。
* 同步 SYN(`SYNchronization`) —— 同步`SYN = 1`表示这是一个连接请求或连接接受报文。当`SYN = 1`而`ACK = 0`时，表明这是一个连接请求报文段。对方若同意建立连接，则应在响应的报文段中使`SYN=1`和`ACK=1`。
* 终止 FIN —— 用来释放一个连接。`FIN = 1`表明此报文段的发送端的数据已发送完毕，并要求释放运输连接。 
* 窗口 —— 占 2 字节，用来让对方设置发送窗口的依据，单位为字节。窗口字段明确指出了现在允许对方发送的数据量。窗口值经常在动态变化着。
* 检验和 —— 占 2 字节。检验和字段检验的范围包括首部和数据这两部分。在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部。在计算检验和时，临时把 12 字节的“伪首部”和 TCP 报文段连接在一起。伪首部仅仅是为了计算检验和。伪首部的格式与 UDP 的伪首部一样。但应把伪首部第 4 个字段中的 17 改为 6(TCP 的协议号是 6)，把第 5 字段中的 UDP 长度改为 TCP 长度。接收方收到此报文段后，仍要加上这个伪首部来计算检验和。
* 紧急指针 —— 占 16 位，紧急指针仅在`URG = 1`时才有意义，指出在本报文段中紧急数据共有多少个字节（紧急数据放在本报文段数据的最前面）。即使窗口为零时也可发送紧急数据。
* 选项字段 —— 长度可变。最长可达 40 字节。当没有使用“选项“时，TCP 的首部长度是 20 字节。
* 填充 —— 这是为了使整个首部长度是 4 字节的整数倍。

TCP 最初只规定了一种选项，即最大报文段长度 MSS。MSS(`Maximum Segment Size`)是 TCP 报文段中的数据字段的最大长度。数据字段加上 TCP 首部才等于整个的 TCP 报文段。所以，MSS是“TCP 报文段长度减去 TCP 首部长度”。

MSS 告诉对方 TCP：“我的缓存所能接收的报文段的数据字段的最大长度是 MSS 个字节。” 

为什么要规定一个最大报文段长度 MSS 呢？这并不是考虑接收方的接收缓存可能放不下 TCP 报文段中的数据。实际上，MSS 与接收窗口值没有关系。我们知道，TCP 报文段的数据部分，至少要加上 40 字节的首部（TCP 首部 20 字节和 IP 首部 20 字节，这里都还没有考虑首部中的选项部分），才能组装成一个 IP 数据报。若选择较小的 MSS 长度，网络的利用率就降低。设想在极端的情况下，当 TCP 报文段只含有 1 字节的数据时，在 IP 层传输的数据报的开销至少有 40 字节（包括 TCP 报文段的首部和 IP 数据报的首部）。这样，对网络的利用率就不会超过 1/41。到了数据链路层还要加上一些开销。但反过来，若TCP 报文段非常长，那么在 IP 层传输时就有可能要分解成多个短数据报片。在终点要把收到的各个短数据报片装配成原来的 TCP 报文段。当传输出错时还要进行重传。这些也都会使开销增大。

因此，MSS 应尽可能大些，只要在 IP 层传输时不需要再分片就行。由于 IP 数据报所经历的路径是动态变化的，因此在这条路径上确定的不需要分片的 MSS，如果改走另一条路径就可能需要进行分片。因此最佳的 MSS 是很难确定的。在连接建立的过程中，双方都把自己能够支持的 MSS 写入这一字段，以后就按照这个数值传送数据，两个传送方向可以有不同的 MSS 值。若主机未填写这一项，则 MSS 的默认值是 536 字节长。因此，所有在互联网上的主机都应能接受的报文段长度是 536 + 20 （固定首部长度）=556 字节。

## 选项字段的其他选项
* 窗口扩大选项 ——占 3 字节，其中有一个字节表示移位值`S`。新的窗口值等于 TCP 首部中的窗口位数增大到`16 + S`，相当于把窗口值向左移动`S`位后获得实际的窗口大小。
* 时间戳选项——占 10 字节，其中最主要的字段时间戳值字段（4 字节）和时间戳回送回答字段（4 字节）。
* 选择确认选项（SACK）。 

窗口扩大选项是为了扩大窗口。我们知道，TCP 首部中窗口字段长度是 16 位，因此最大的窗口大小为64K字节。虽然这对早期的网络是足够用的，但对于包含卫星信道的网络，传播时延和带宽都很大，要获得高吞吐率需要更大的窗口大小。

窗口扩大选项可以在双方初始建立 TCP 连接时进行协商。如果连接的某一端实现了窗口扩大，当它不再需要扩大其窗口时，可发送`S = 0`的选项，使窗口大小回到 16。

时间戳选项有以下两个功能：
* 第一，用来计算往返时间 RTT。发送方在发送报文段时把当前时钟的时间值放入时间戳字段，接收方在确认该报文段时把时间戳字段值复制到时间戳回送回答字段。因此，发送方在收到确认报文后，可以准确地计算出 RTT 来。
* 第二，用于处理 TCP 序号超过 2<sup>32</sup>的情况，这又称为防止序号绕回 PAWS （`Protect Against Wrapped Sequence numbers`）。我们知道，TCP 报文段的序号只有 32 位,而每增加 2<sup>32</sup>个序号就会重复使用原来用过的序号。当使用高速网络时，在一次 TCP 连接的数据传送中序号很可能会被重复使用。例如，当使用 1.5Mbit/s 的速率发送报文段时，序号重复要 6 小时以上。但若用 2.5Gbit/s 的速率发送报文段，则不到 14 秒钟序号就会重复。为了使接收方能够把新的报文段和迟到很久的报文段区分开，可以在报文段中加上这种时间戳。