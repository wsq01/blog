---
title: 网络层——路由选择协议
date: 2020-09-26 17:11:08
tags: 计算机网络
categories: 计算机网络
---


# 有关路由选择协议的几个基本概念
## 理想的路由算法
路由选择协议的核心就是路由算法，即需要何种算法来获得路由表中的各项目。

一个理想的路由算法有如下特点：
* 算法必须是正确的和完整的。 
* 算法在计算上应简单。 
* 算法应能适应通信量和网络拓扑的变化，这就是说，要有自适应性。 
* 算法应具有稳定性。 
* 算法应是公平的。 
* 算法应是最佳的。

### 关于“最佳路由”
不存在一种绝对的最佳路由算法。所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已。

实际的路由选择算法，应尽可能接近于理想的算法。

路由选择是个非常复杂的问题，它是网络中的所有结点共同协调工作的结果。路由选择的环境往往是不断变化的，而这种变化有时无法事先知道。 

### 从路由算法的自适应性考虑
从路由算法能否随网络的通信量或拓扑自适应的进行调整变化划分有两类：
* 静态路由选择策略——即非自适应路由选择，其特点是简单和开销较小，但不能及时适应网络状态的变化。适用于简单的小网络。
* 动态路由选择策略——即自适应路由选择，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。适用于较复杂的大网络。

## 分层次的路由选择协议
互联网采用的路由选择协议主要是自适应的（即动态的）、分布式路由选择协议。

互联网采用分层次的路由选择协议原因：
1. 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和。
2. 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上。

为此，可以把整个互联网划分为许多小的自治系统。
### 自治系统 AS (Autonomous System) 
自治系统 AS 的定义：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS 之间的路由。

尽管一个 AS 使用了多种内部路由选择协议和度量，但重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略。

{% asset_img img1.png %}

### 互联网有两大类路由选择协议：
* 内部网关协议 IGP(`Interior Gateway Protocol`)，在一个自治系统内部使用的路由选择协议。目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。
* 外部网关协议 EGP(`External Gateway Protocol`) ，若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。在外部网关协议中目前使用最多的是 BGP-4。

{% asset_img img2.png %}

自治系统之间的路由选择也叫做域间路由选择(`interdomain routing`)，在自治系统内部的路由选择叫做域内路由选择(`intradomain routing`) 。
### 互联网的路由选择协议

{% asset_img img3.png %}

# 内部网关协议 RIP
## 工作原理
路由信息协议 RIP(`Routing Information Protocol`) 是内部网关协议 IGP 中最先得到广泛使用的协议。

RIP 是一种分布式的、基于距离向量的路由选择协议。

RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。

RIP 距离定义：从一路由器到直接连接的网络的距离定义为1；从一路由器到非直接连接的网络的距离定义为所经过的路由器数加1；

RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。

RIP 允许一条路径最多只能包含 15 个路由器。因此，“距离”的最大值为 16 时即相当于不可达。可见 RIP 只适用于小型互联网。

RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。 
### RIP 协议的三个特点：
* 仅和相邻路由器交换信息。 
* 交换的信息是当前本路由器所知道的全部信息，即自己的路由表。 
* 按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

### 路由表的建立
路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为 1）。它的路由表是空的。

以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。

经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。

RIP 协议的收敛过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。
## 距离向量算法
路由器收到相邻路由器（其地址为 X）的一个 RIP 报文：
1. 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。
2. 对修改后的 RIP 报文中的每一个项目，重复以下步骤：
  * 若项目中的目的网络不在路由表中，则把该项目加到路由表中。
  * 否则，若下一跳字段给出的路由器地址是同样的，则把收到的项目替换原路由表中的项目。
  * 否则，若收到项目中的距离小于路由表中的距离，则进行更新，
  * 否则，什么也不做。
3. 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）。
4. 返回。

距离向量算法的基础就是`Bellman-Ford`算法（或`Ford-Fulkerson`算法）。这种算法的要点是这样的：设X是结点 A 到 B 的最短路径上的一个结点。若把路径 A→B 拆成两段路径 A→X 和 X→B，则每一段路径 A→X 和 X→B 也都分别是结点 A 到 X 和结点 X 到 B 的最短路径。

RIP 协议让互联网中的所有路由器都和自己的相邻路由器不断交换路由信息，并不断更新其路由表，使得从每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）。

虽然所有的路由器最终都拥有了整个自治系统的全局路由信息，但由于每一个路由器的位置不同，它们的路由表当然也应当是不同的。

已知路由器 R6 有表 a 所示的路由表。现在收到相邻路由器 R4 发来的路由更新信息。试更新路由器 R6 的路由表。

{% asset_img img4.png %}
<br>
{% asset_img img5.png %}

## RIP2 协议的报文格式
{% asset_img img6.png %}

RIP2 报文由首部和路由部分组成。

RIP2 报文中的路由部分由若干个路由信息组成。每个路由信息需要用 20 个字节。地址族标识符（又称为地址类别）字段用来标志所使用的地址协议。

路由标记填入自治系统的号码，这是考虑使 RIP 有可能收到本自治系统以外的路由选择信息。

再后面指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。 

一个 RIP 报文最多可包括 25 个路由，因而 RIP 报文的最大长度是 4+20 x25=504 字节。如超过，必须再用一个 RIP 报文来传送。

RIP2 具有简单的鉴别功能。

若使用鉴别功能，则将原来写入第一个路由信息（20 个字节）的位置用作鉴别。

在鉴别数据之后才写入路由信息，但这时最多只能再放入 24 个路由信息。

RIP 协议特点：好消息传播得快，坏消息传播得慢。

RIP 存在的一个问题：当网络出现故障时，要经过比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器。

{% asset_img img7.png %}
<br>
{% asset_img img8.png %}
<br>
{% asset_img img9.png %}
<br>
{% asset_img img10.png %}
<br>
{% asset_img img11.png %}
<br>
{% asset_img img12.png %}

### RIP 协议的优缺点
优点：实现简单，开销较小。
缺点：
* RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
* 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。 
* “坏消息传播得慢”，使更新过程的收敛时间过长。

# 内部网关协议 OSPF
开放最短路径优先 OSPF(`Open Shortest Path First`)是为克服 RIP 的缺点开发出来的。“开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法 SPF。

采用分布式的链路状态协议(`link state protocol`)。 

注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。
## 三个要点
向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法。

发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。

“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”。 

只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息。
## 链路状态数据库 (link-state database)
由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库。

这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（这称为链路状态数据库的同步）。

OSPF 的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。

OSPF 的更新过程收敛得快是其重要优点。
## OSPF 的区域 (area) 
为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫做区域。

每一个区域都有一个 32 位的区域标识符（用点分十进制表示）。

区域也不能太大，在一个区域内的路由器最好不超过 200 个。 
## 划分区域
OSPF 划分为两种不同的区域

{% asset_img img13.png %}

划分区域的好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。

在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。

OSPF 使用层次结构的区域划分。在上层的区域叫做主干区域。

主干区域的标识符规定为`0.0.0.0`。主干区域的作用是用来连通其他在下层的区域。

OSPF 不用 UDP 而是直接用 IP 数据报传送。

OSPF 构成的数据报很短。这样做可减少路由信息的通信量。

数据报很短的另一好处是可以不必将长的数据报分片传送。

但分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传。

OSPF 对不同的链路可根据 IP 分组的不同服务类型 TOS 而设置成不同的代价。因此，OSPF 对于不同类型的业务可计算出不同的路由。

如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫做多路径间的负载平衡。

所有在 OSPF 路由器之间交换的分组都具有鉴别的功能。

支持可变长度的子网划分和无分类编址 CIDR。

每一个链路状态都带上一个 32 位的序号，序号越大状态就越新。

{% asset_img img14.png %}

## OSPF 的五种分组类型
类型1，问候 (`Hello`) 分组。
类型2，数据库描述(`Database Description`)分组。
类型3，链路状态请求(`Link State Request`)分组。
类型4，链路状态更新(`Link State Update`)分组，用洪泛法对全网更新链路状态。
类型5，链路状态确认(`Link State Acknowledgment`)分组。

### OSPF 的基本操作

{% asset_img img15.png %}
<br>
{% asset_img img16.png %}

OSPF 还规定每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态。

由于一个路由器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当互联网规模很大时，OSPF  协议要比距离向量协议 RIP 好得多。

OSPF 没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于 100 ms。 

多点接入的局域网采用了指定的路由器(`designated router`)的方法，使广播的信息量大大减少。

指定的路由器代表该局域网上所有的链路向连接到该网络上的各路由器发送状态信息。 
# 外部网关协议 BGP
BGP 是不同自治系统的路由器之间交换路由信息的协议。 

BGP 较新版本是BGP-4（BGP 第 4 个版本）。可以将 BGP-4 简写为 BGP。 

互联网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。

当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。

比较合理的做法是在 AS 之间交换“可达性”信息。

自治系统之间的路由选择必须考虑有关策略。

因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。

每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人” (`BGP speaker`) 。

一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。 

一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话，利用 BGP 会话交换路由信息。

使用 TCP 连接能提供可靠的服务，也简化了路由选择协议。

使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站(`neighbor`)或对等站(`peer`)。

BGP 发言人和自治系统 AS 的关系

{% asset_img img17.png %}

BGP 所交换的网络可达性的信息就是要到达某个网络所要经过的一系列 AS。

当 BGP 发言人互相交换了网络可达性的信息后，各 BGP 发言人就根据所采用的策略从收到的路由信息中找出到达各 AS 的较好路由。

{% asset_img img18.png %}
<br>
{% asset_img img19.png %}

自治系统 AS2 的 BGP 发言人通知主干网 AS1 的 BGP 发言人：“要到达网络 N1、 N2、N3 和 N4 可经过 AS2。” 

主干网还可发出通知：“要到达网络 N5、N6 和 N7 可沿路径（AS1, AS3）。” 
## BGP 协议的特点
BGP 协议交换路由信息的结点数量级是自治系统数的量级，这要比这些自治系统中的网络数少很多。

每一个自治系统中 BGP 发言人（或边界路由器）的数目是很少的。这样就使得自治系统之间的路由选择不致过分复杂。

BGP 支持 CIDR，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。

在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销都有好处。

BGP-4 共使用四种报文
* 打开 (`OPEN`) 报文，用来与相邻的另一个BGP发言人建立关系。
* 更新 (`UPDATE`) 报文，用来发送某一路由的信息，以及列出要撤消的多条路由。
* 保活 (`KEEPALIVE`) 报文，用来确认打开报文和周期性地证实邻站关系。
* 通知 (`NOTIFICATION`) 报文，用来发送检测到的差错。

BGP 报文具有通用首部

{% asset_img img20.png %}

# 路由器的构成
路由器是一种典型的网络层设备。

路由器的主要作用是：
* 连通不同的网络。
* 选择信息传送的线路。选择通畅快捷的近路，能大大提高通信速度，减轻网络系统通信负荷，节约网络系统资源，提高网络系统畅通率，从而让网络系统发挥出更大的效益来。

## 路由器的结构
路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组。也就是说，将路由器某个输入端口收到的分组，按照分组要去的目的地（即目的网络），把该分组从路由器的某个合适的输出端口转发给下一跳路由器。

下一跳路由器也按照这种方法处理分组，直到该分组到达终点为止。

路由器的转发分组正是网络层的主要工作。

### 典型的路由器的结构

{% asset_img img21.png %}

整个的路由器结构可划分为两大部分：路由选择部分、分组转发部分。

路由选择部分也叫做控制部分，其核心构件是路由选择处理机。

路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表。

分组转发部分由三部分组成：
* 交换结构 (`switching fabric`)：又称为交换组织，其作用是根据转发表 (`forwarding table`) 对分组进行处理。
* 一组输入端口
* 一组输出端口

（请注意：这里的端口就是硬件接口）

“转发”(`forwarding`) 就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。

“路由选择”则是按照分布式算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由。

路由表是根据路由选择算法得出的。而转发表是从路由表得出的。

在讨论路由选择的原理时，往往不去区分转发表和路由表的区别。
### 输入端口对线路上收到的分组的处理
路由器的输入端口里面装有物理层、数据链路层和网络层的处理模块。

数据链路层剥去帧首部和尾部后，将分组送到网络层的队列中排队等待处理。这会产生一定的时延。 

输入端口中的查找和转发功能在路由器的交换功能中是最重要的。

{% asset_img img22.png %}

输出端口里面装有物理层、数据链路层和网络层的处理模块。

输出端口从交换结构接收分组，然后把它们发送到路由器外面的线路上。

在网络层的处理模块中设有一个缓冲区（队列）。当交换结构传送过来的分组的速率超过输出链路的发送速率时，来不及发送的分组就必须暂时存放在这个队列中。

数据链路层处理模块将分组加上链路层的首部和尾部，交给物理层后发送到外部线路。 

{% asset_img img23.png %}

### 分组丢弃
若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃。
路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因。
## 交换结构
交换结构是路由器的关键构件。

正是这个交换结构把分组从一个输入端口转移到某个合适的输出端口。

实现交换有多种方法。常用交换方法有三种：通过存储器、通过总线、通过纵横交换结构。

### 通过存储器
(1) 当路由器的某个输入端口收到一个分组时，就用中断方式通知路由选择处理机。然后分组就从输入端口复制到存储器中。
(2) 路由器处理机从分组首部提取目的地址，查找路由表，再将分组复制到合适的输出端口的缓存中。
(3) 若存储器的带宽（读或写）为每秒 M 个分组，那么路由器的交换速率（即分组从输入端口传送到输出端口的速率）一定小于 M/2。

### 通过总线
(1) 数据报从输入端口通过共享的总线直接传送到合适的输出端口，而不需要路由选择处理机的干预。
(2) 因为每一个要转发的分组都要通过这一条总线，因此路由器的转发带宽就受总线速率的限制。
(3) 现代的技术已经可以将总线的带宽提高到每秒吉比特的速率，因此许多的路由器产品都采用这种通过总线的交换方式。

### 通过纵横交换结构(`crossbar switch fabric`)
(1) 这种交换结构常称为互连网络(`interconnection network`)。
(2) 它有 2N 条总线，可以使 N 个输入端口和 N 个输出端口相连接。
(3) 当输入端口收到一个分组时，就将它发送到与该输入端口相连的水平总线上。
(4) 若通向所要转发的输出端口的垂直总线是空闲的，则在这个结点将垂直总线与水平总线接通，然后将该分组转发到这个输出端口。
(5) 但若该垂直总线已被占用（有另一个分组正在转发到同一个输出端口），则后到达的分组就被阻塞，必须在输入端口排队。

{% asset_img img24.png %}