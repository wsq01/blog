


# 交换机分类
## 根据功能分类
交换机按照功能可以分为二层交换机和三层交换机。
* 二层交换机：没有 IP 路由功能、仅处理数据链路层的交换机叫做二层交换机。
* 三层交换机：带有 IP 路由功能的交换机叫做三层交换机。

## 根据外形分类
根据外形，交换机可分为桌面式交换机、箱式交换机和机框式交换机。
* 桌面式交换机

桌面式交换机是指放在桌面上使用的交换机。它体积不大，只能连接几台网络设备，通常用于家庭网络中，主要有 3 端口、5 端口、8 端口和 16 端口的产品。

桌面式交换机通常不安装风扇，采用无风扇设计，运行噪声小。

* 箱式交换机

箱式交换机通常高度是 1U 或 2U ，可以安装在 19 英寸的机柜内。通常采用金属外壳、内置电源，并配置冷却风扇。下行有 24 千兆网口或 48 千兆网口，上行有 2 万兆光口或 4 万兆光口的配置较多。下行使用 RJ-45 的网线接口，上行使用 SFP+ 槽进行连接。

主要作为企业中作为接入交换机使用，支持电源冗余。

* 框式交换机

框式交换机是指在机框内组合多个接口模块的交换机。可以根据需要选择端口数量和不同类型的接口模块，扩展性好，端口数量多。

在机框中可以添加电源、风扇等组成部分，再插入管理模块和接口模块。接口模块和管理模块叫做线卡。机框上总线的主板叫做背板，可以插入线卡。

## 根据用途分类
根据交换机在网络中的位置和用途，可分为三类：核心交换机（核心层）、汇聚交换机（汇聚层）和接入交换机（接入层）。

核心交换机不是某种网络交换机，它是指位于网络主干或物理核心的数据交换机，因此，它必须是一个大容量的交换机，以作为通往广域网（WAN）或互联网的网关，总之，它为网络提供了最终的聚合点，并允许各种聚合模块协同工作。

汇聚交换机位于汇聚层，向上连接核心交换机，向下连接到接入交换机，也称为分布交换机，作为核心层交换机和接入层交换机之间的桥梁。

此外，汇聚交换机确保数据包在企业网络中的子网和 VLAN 之间正确路由。

接入交换机一般位于接入层，用于将大多数设备连接到网络，因此通常具有高密度端口，它是最常用的千兆以太网交换机，直接与公共互联网通信，主要用于办公室、小型服务器机房和媒体制作中心，托管和非托管交换机都可以部署为接入层交换机。

交换机可以共存于同一网络中，并相互协调以实现不受限制的网络速度，每个层交换机执行自己的职责。

{% asset_img 1.png %}

# 交换机端口类型
## 千兆以太网端口
大部分交换机都配置了 RJ-45 的千兆以太网接口，连接千兆接口要使用增强型 5 类双绞线。通过自适应功能，还可以连接百兆接口。
## 光纤端口
箱式交换机会配置光纤端口，主要是用于连接上行链路。为了连接万兆以太网的上行链路，通常会搭载 SFP+ 接口。

框式交换机中，一般会配置多个千兆以太网 SFP 或万兆以太网 SFP+ 接口的接口卡。
## PoE 端口
接入交换机还会配 PoE 端口。PoE 端口使用网线连接 IP 电话或无线 AP ，并通过网线对设备进行供电。

为了让 IP 电话或无线 AP 无需外接电源也能接入网络，通过一根网线给设备供电的技术就是 PoE 技术。PoE 技术有简化布线、节省人工成本，管理方便，使用灵活，安全等优点，得到广泛的应用。

PoE 技术作为 IEEE 802.af 在 2003 年完成了标准化工作，这个技术还用于网络摄像头、POS 终端等连接以太网的硬件设备。

PoE（ IEEE 802.3af ） PoE+（ IEEE 802.3at ）PoE++（ IEEE 802.3bt ）

PoE 的供电标准是 IEEE 802.3af ，最大能提供 15.4W 的功率，可以为 IP 电话、无线 AP 等终端设备供电。
## 上行链路端口
接入交换机和汇聚交换机要集中下行连接的所有设备流量，并将流量传输到上行的网关或核心交换机中，向网关、核心交换机传输流量的端口叫做上行链路端口，反向就叫做下行链路端口。在箱式交换机中一般会配置 2~4 个万兆上行链路端口。
## 下行链路端口
通常下行链路是 RJ-45 的接口，也有使用光纤接口的。一台交换机或一块板块，能提供 24 或 48 个接口。
# 交换机功能
## MAC 地址数
MAC 地址数是指一台交换机最大可以学习到的 MAC 地址表数量。
## 生成树功能
为了避免二层环路，我们使用生成树协议（STP），让交换机知道对方的存在，具体做法是在交换机之间交换 BPDU 数据帧。
## 链路聚合
链路聚合是将交换机的多条线路汇聚成一条逻辑线路在网络中使用。有多个称呼：端口聚合、链路捆绑、绑定等。

如果不使用链路聚合功能，直接将交换机的多个物理端口连接起来，可能会导致网络环路。如果使用生成树协议，又会避开某些链路，导致只有一条物理链路可用。如果使用链路聚合，把几条物理链路聚合成一条逻辑链路，即使某一条物理链路断开，由于逻辑线路还有其它物理链路在维持，因此通信也不会中断，到达线路冗余的效果。
## VLAN
将广播域分割成一个个逻辑网段的功能叫做 VLAN 。
## 端口镜像
将某个端口接收和发送的数据帧复制到镜像端口的功能叫做端口镜像，被复制的源端口叫做监控端口。

为了分析网络故障或检测网络中的流量，交换机会将收到的数据帧复制一份并转发到网络分析设备或流量监控设备中。
## QoS 优先级队列
QoS 是`Quality of Service`的缩写，也叫做服务质量。当数据通过网络设备时，根据通信种类控制通信优先级和带宽的功能。通常是将声音、视频等数据定义为高优先级，高优先数据优先处理，保障这类数据的稳定和低延迟。

除了交换机在二层进行的 QoS 控制外，还有路由器和三层交换机的三层（IP）的 QoS 控制，以及 TCP 进行的四层的 QoS 控制。

IEEE 802.1p 标准完成了对二层的 QoS 优先级控制的标准化工作。通过 3bit 长度的优先级控制信息，定义了从 0 到 7 的 8 个优先级，即 CoS 值（服务等级值），交换机会优先转发值大的数据帧。
## MAC 地址过滤
为了网络安全，只让指定的设备接入网络。二层交换机提供了以数据帧的头部信息进行过滤的功能。具体过程是，先设置一个过滤条件，比如目的 MAC 地址、源 MAC 地址等，满足条件的数据帧通过，阻断不满足条件的数据帧。

考虑到伪造 MAC 地址的情况发生，还可以跟 802.1X 一起使用。三层交换机或路由器可以根据 IP 头部信息完成 IP 通信过滤的功能。
## 基于端口的认证
在交换机中，只有通过认证的客户端才能使用有线端口。这个功能由 IEEE 802.1X 完成标准化，对接入 LAN 的客户端进行认证的机制。

当 PC 连接交换机时，认证过程启动。根据发送方的 MAC 地址信息进行客户端识别，通过用户名、口令或证书等认证信息进行用户认证。对于没有认证的客户端发来的数据帧，交换机只接收包含认证信息的数据帧，其余的全部丢弃。对于认证失败的客户端发来的数据帧，交换机就直接丢弃不会进行转发。

要使用基于端口的认证功能，客户端的电脑和交换机都要支持 802.1X 认证功能，缺一不可。

802.1X 认证中使用 PPP 的扩展协议 EAP ，通过 EAPOL 协议封装 EAP 认证消息，然后在 LAN 中进行传输。认证结束之前，客户端电脑只能进行 EAPOL 通信。
## 网络管理
远程管理、监控和配置网络设备可以使用 SNMP 协议。SNMP 协议可以对整个网络结构内的交换机和其它网络设备进行集中统一的管理。

被 SNMP 管理的网络设备叫做 Agent ，管理网络的设备叫做 Manager 。
# 交换机的架构
交换机的基本架构是由 RJ-45 接口、PHY 、MAC 等模块的 NIC 和管理由 NIC 收发帧缓存、转发表的软件组成，通过查看转发表信息，在 NIC 之间进行数据帧交互。

{% asset_img 2.png %}

# 交换机优点
| 优点 | 说明 |
| :--: | :--: |
| 隔离冲突域 | 冲突域只在交换机端口和主机之间 |
| 全双工通信 | 冲突域没有其它主机，主机能够同时发送和接收数据帧 |
| 丢弃错误帧 | 交换机能够检测数据帧是否有错误，并丢弃错误的数据帧 |
| 独享带宽 | 发送和接收分别是不同的交换机端口，每个端口独享带宽 |

# 交换机如何转发数据帧？
交换机收到数据帧后，会有三种处理方法：直通转发、碎片隔离和存储转发。

## 直通转发
直通转发是交换机只读取数据帧的前 14 个字节就进行转发。由于读取的数据量固定，发送方和接收方的速度需要一致，导致无法桥接不同速率的以太网。另外，只读取前 14 个字节，会跳过了 FCS 域，因此无法检测并丢弃 CRC 校验错误的数据帧。

{% asset_img 3.png %}

## 碎片隔离
碎片隔离是读取数据帧的前 64 个字节就进行转发，可以防止转发小于 64 字节的残帧。但是如果出现 CRC 错误，还是会转发数据帧。也无法桥接不同速率的以太网。

{% asset_img 4.png %}

## 存储转发
存在转发会读取数据帧全部内容再进行转发。这样就可以识别残帧和 CRC 校验错误帧，并将它们丢弃。交换机还能对数据帧进行缓存，因此可以桥接不同速率的以太网。

| 转发方式 | 读取字节数 | 通信时延 | 丢弃错误数据帧 |
| :--: | :--: | :--: | :--: |
| 直通转发 | 14字节 | 最短 | 无 |
| 碎片隔离 | 64字节 | 短   | 只丢弃残帧 |
| 存储转发 | 全部   | 最长 | 全部 |

# 二层交换机和三层交换机
二层交换机工作在数据链路层，可以处理数据帧。

{% asset_img 9.png %}

三层交换机：一个具有三层交换功能的设备，即带有第三层路由功能的第二层交换机，但它是二者的有机结合，并不是简单地把路由器设备的硬件及软件叠加在局域网交换机上。三层交换机工作在网络层，可以处理数据包。

{% asset_img 10.png %}


这两种类型交换机的工作方式有所不同：
* 二层交换机可以识别数据包中的 MAC 地址，根据 MAC 地址进行转发，并将这些 MAC 地址与对应的端口记录在自己内部的一个地址表中。二层交换机不遵循路由算法。
* 三层交换机转发基于目标 IP 地址，数据包的目的地是定义的下一跳，三层交换机遵循路由算法。

## 二层交换机
二层交换机通过遵循 ARP (地址解析协议)来学习下一跳的 MAC 地址。
 
我们以网络为例，其中一个交换机连接到四个主机设备，称为 PC1、PC2、PC3 和 PC4。现在，PC1 第一次要向 PC2 发送一个数据包。
 
虽然 PC1 在第一次通信时知道 PC2 的 IP 地址，但它不知道接收主机的 MAC地址。因此，交换机向所有端口发送ARP请求（不包括PC1所连接的端口），PC2 收到 ARP 请求后，将回复一个带有其 MAC 地址的 ARP 响应消息。这样，PC2 也就收集到了PC1 的 MAC 地址。
 
通过上述消息的来回流动，交换机就知道哪些MAC地址分配给了哪些端口。同样，当 PC2 在 ARP 响应消息中发送其 MAC 地址时，交换机会收集 PC2 的 MAC 地址并将其存储到自己的 MAC 地址表中。
 
从现在开始，每当 PC1 想要向 PC2 发送任何数据时，交换机只需在其地址表中查找并转发到 PC2 的目标端口。
 
如此，交换机将继续维护每个连接主机的硬件地址。

{% asset_img 5.png %}

### 冲突和广播域
在二层交换中，当两个或多个主机试图在同一网络链路上以相同的时间间隔进行通信时，可能会发生冲突。当数据帧发生冲突，设备必须重新发送数据。冲突对网络性能有严重的负面影响，因此绝对要避免冲突。
 
广播是一种信息的传播方式，指网络中的某一设备同时向网络中所有的其他设备发送数据，这个数据所能广播到的范围即为广播域。简单点说，广播域就是指网络中所有能接收到同样广播消息的设备的集合。
 
使用一个或多个交换机组成的以太网，所有站点都在同一个广播域。随着交换机变多，这个广播域的范围也会变大，于是就会出现难以维护、广播风暴以及安全等问题。
 
一个主机想要获取另外一个网段的主机 MAC 地址，需要发送 ARP 广播请求获取对方主机的 MAC 地址。这个广播请求会广播到每一个主机身上，容易导致广播风暴。
### VLAN
为了克服冲突和广播域问题，在计算机网络系统中引入了 VLAN(虚拟局域网)技术。
 
分隔广播域有两种方法：
1. 物理分隔：将网络从物理上划分为若干个小网络
2. 逻辑分隔：将网络从逻辑上划分为若干个小的虚拟网络，即 VLAN
 
物理分隔有很多缺点，会使得局域网的设计缺乏灵活性，而 VLAN 则具有灵活性和可扩展性。VLAN配置是在交换机级通过使用不同的接口完成的，不同的交换机可以有不同或相同的 VLAN 配置，并可以根据网络的需要进行设置。
 
在同一个 VLAN 内的设备和用户并不受物理位置的限制，可以根据功能、部门及应用等因素将它们组织起来，相互之间的通信就好像在同一个网段中一样。因此，与不同交换机相连的主机可以共享同一个广播域。
 
为了更好地理解 VLAN ，我们举个栗子，其中一个使用 VLAN，另一个不使用 VLAN。
如果没有 VLAN，从主机 1 发送的广播消息将到达网络中的所有设备。

{% asset_img 6.png %}

如果给网络中的两个交换机添加一个名为`fast Ethernet 0`和`fast Ethernet 1`的接口卡（通常表示为 Fa0/0）来配置 VLAN，来自主机1 的广播消息将仅发送到主机2。

{% asset_img 7.png %}

在进行配置时会发生这种情况：只有主机 1 和主机 2 定义在同一组 VLAN 下，而其他设备组件是别的 VLAN 网络的成员。
 
需要注意的是，二层交换机只能允许主机设备与同一个VLAN的主机通信。要到达另一个网络的主机设备，需要三层交换机或路由器。
 
VLAN 网络高度安全，因为其配置类型，任何文件都可以通过两个预定义的、物理上没有连接的同一 VLAN 的主机发送。广播流量也由它管理，因为消息将仅发送和接收到定义的 VLAN集，而不是网络上的每个设备。
### 访问和中继端口
在交换机端口上可以完成各种类型的配置，给 VLAN 分配一个访问端口，就可以访问单个 VLAN 网络。
 
当我们只需要简单地将主机终端设备配置到特定的 VLAN 网络时，就会使用访问端口。
 
如果需要访问多个交换机，且需要访问不同的 VLAN，则将接口配置为交换机的中继端口。中继端口的智能程度足以承受多个 VLAN 的流量。
### 配置 VLAN
要在交换机上配置 VLAN，首先要在交换机上启用 IOS 模式。
创建 VLAN 的命令为`config mode VLAN NUMBER i.e. Switch(config)# VLAN 10`。
通过使用接口命令，我们可以在 VLAN 下分配快速以太网端口。
通过使用`switchport`访问命令行，我们可以指定接口是访问模式。
下一条命令将分配 VLAN 编号到交换机端口访问模式。
```
Switch(config) #vlan 10 
Switch(config-vlan) #exit 
Switch(config) #int fa0/1 
Switch(config-if) #switchport mode access 
Switch(config-if) #switchport access vlan 10
```

`switchport access mode`命令只能分配给单个 VLAN。当需要配置多个 VLAN，使用`switchport trunk mode interface`命令，因为它可以承载多个 VLAN 的流量。
### 二层交换机的特点
* 二层交换机可以充当网桥，将计算机网络系统的各种终端设备连接在一个平台上。它们能够非常快速且有效地将数据从LAN 网络的源端传输到目标端。
* 二层交换机通过从交换机的地址表中学习目的节点的MAC地址，执行交换功能，将数据帧从源端重新排列到目的端。
* MAC地址表为二层设备提供了唯一的地址，用于标识数据下发的终端设备和节点。
* 二层交换机将庞大复杂的 LAN 网络拆分为一个个小的 VLAN 网络。
* 通过在一个大型的 LAN 网络中配置多个 VLAN，在没有物理连接的情况下，交换变得更快。

### 二层交换机的应用
* 通过二层交换机，我们可以轻松地将位于同一 VLAN 内的数据帧从源端发送到目的端，而无需物理连接或位于同一位置。
* 因此，软件公司的服务器可以集中放置在一个位置，而分散在其他位置的客户端可以轻松访问数据而没有延迟，从而节省服务器成本和时间。
* 组织可以通过使用这些类型的交换机将主机配置在同一个 VLAN 中，而不需要任何互联网连接，从而实现内部通信。

## 三层交换机
当我们需要在不同的 LAN 或 VLAN 之间传输数据时，二层交换机就无法满足了。这时需要三层交换机，因为它们将数据包路由到目的地的技术是 IP 地址和子网划分。
 
三层交换机工作在 OSI 参考模型的第3层，并使用 IP 地址执行数据包的路由。它们比二层交换机具有更快的切换速度，甚至比传统路由器更快，因为它们不使用额外的跃点来执行数据包的路由，从而会带来更好的性能。

第3层中的源端设备首先查看自己的路由表，路由表中包含了源 IP 地址、目的 IP 地址和子网掩码的所有信息。然后，根据它从路由表中收集的信息，将数据包发送到目的地，并可以在不同的 LAN、MAN 和 WAN 网络之间进一步传递数据。它遵循最短且安全的路径在终端设备之间传递数据。这就是路由的总体概念。

各种网络可以通过 STM 链路连接在一起，STM 链路有很高的带宽，DS3链路也可以。连接的类型取决于网络的各种参数。
### 三层交换机的特点
三层交换机的各种特性如下所示：
* 执行静态路由，以在不同 VLAN 之间传输数据。而二层设备只能在同一 VLAN 网络之间传输数据。
* 以与路由器相同的方式执行动态路由，这种动态路由技术允许交换机执行最佳数据包路由。
* 根据网络的实时场景提供一组多路径来传递数据包。交换机可以选择最可行的路径来路由数据包，目前流行的路由技术包括 RIP 和 OSPF。
* 有能力识别关于流量流向的交换机的相关 IP 地址信息。
* 能够根据子网划分或 VLAN 流量标记部署 QoS 分类，而不是像二层交换机那样手动配置交换机端口。
* 需要更多的功率来运行，并在交换机之间提供更高带宽的链路，这些链路几乎超过 10Gbits。
* 为数据交换提供高度安全的路径。

### 三层交换机的应用
三层交换机的应用如下:
* 被广泛用于数据中心等大型园区。三层交换机具有静态路由和动态路由等特点，且交换速度比路由器快，因此它被用于局域网连接中，用于多个 VLAN 和 LAN 网络的互连。
* 三层交换机与多台二层交换机相结合，可以支持更多用户接入网络，无需额外部署三层交换机和更多带宽。如果一个网络平台上的终端用户数量增加，那么无需对网络进行任何增强，就可以轻松地将其容纳在同一个运行场景中。
* 三层交换机可以轻松处理高带宽资源和最终用户应用，它提供了 10Gbits 带宽。
* 三层交换机有能力解除过载的路由器的负担。在广域网场景中，每个三层交换机都有一个主路由器，这样交换机就可以管理所有的本地 VLAN 路由。
* 通过遵循上述类型的场景，路由器的工作效率将会提高，并且可以专门用于长距离（WAN）连接和数据传输。
* 三层交换机可以利用其高带宽处理和管理本地连接的服务器和终端设备的路由和流量控制。因此，公司通常使用三层交换机来连接其监控服务器和子系统NOC中心的主机节点。

### 三层交换机的 VLAN 间路由
下图显示了三层交换机与二层交换机相结合的跨 VLAN 路由操作。
 
我们再举个栗子来帮助理解：

在大学中，教职员工和学生的 PC 通过二层和三层交换机连接在不同的 VLAN 上。

{% asset_img 8.png %}

某教职员工 VLAN 的 PC1 想其他教员 VLAN 中的 pc2 进行通信。由于两个终端设备属于不同的 VLAN，我们需要三层交换机将数据从 PC1 路由到 PC2。
 
首先，二层交换机借助硬件部分的 MAC 地址表来定位目标主机。然后从 MAC 表中学习接收主机的目的地址。之后，三层交换机根据IP地址和子网掩码进行交换和路由，它将明确 PC1 希望和哪个 VLAN 网络的目标 PC 通信。一旦它收集了所有必要的信息，将在它们之间建立链接，并将数据从发送端路由到接收端。这样就完成了不同 VLAN 间的通信。
## 总结
二层与三层交换机之间有以下区别：
* 工作层级不同：二层交换机工作在数据链路层，三层交换机工作在网络层，三层交换机不仅实现了数据包的高速转发，还可以根据不同网络状况达到最优网络性能。
* 原理不同：二层交换机的原理是当交换机从某个端口收到一个数据包，它会先读取包中的源MAC地址，再去读取包中的目的MAC地址，并在地址表中查找对应的端口，如表中有和目的MAC地址对应的端口，就把数据包直接复制到这个端口上。三层交换机的原理比较简单，就是一次路由多次交换，通俗来说就是第一次进行源到目的的路由，三层交换机会将此数据转到二层，那么下次无论是目的到源还是源到目的都可以进行快速交换。
* 功能不同：二层交换机基于MAC地址访问，只做数据的转发，并且不能配置IP地址，而三层交换机将二层交换技术和三层转发功能结合在一起，也就是说三层交换机在二层交换机的基础上增加了路由功能，可配置不同VLAN的IP地址，可通过三层路由实现不同VLAN之间通讯。
* 应用不同：二层交换机主要用于网络接入层和汇聚层，而三层交换机主要用于网络核心层，但是也存在少部分三层交换机用于汇聚层的现象。
* 支持的协议不同：二层交换机支持物理层和数据链路层协议，而三层交换机支持物理层、数据链路层及网络层协议。
