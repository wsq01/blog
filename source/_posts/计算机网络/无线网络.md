

# 无线局域网 WLAN
## 无线局域网的组成
无线局域网 WLAN(`Wireless Local Area Network`) 指采用无线通信技术的局域网。

特点：
* 提供了移动接入的功能
* 节省投资，建网速度较快
* 支持便携设备联网

由于手机普及率日益增高，通过无线局域网接入到互联网已成为当今上网的最常用的方式。

无线局域网 WLAN 可分为两大类：有固定基础设施的 WLAN、无固定基础设施的 WLAN。

所谓“固定基础设施”是指预先建立起来的、能够覆盖一定地理范围的一批固定基站。
###  IEEE 802.11
IEEE 802.11 是一个有固定基础设施的无线局域网的国际标准。

IEEE 802.11 是个相当复杂的标准。但简单地说，802.11 就是无线以太网的标准：
* 它使用星形拓扑，其中心叫做接入点 AP (Access Point)
* 在MAC层使用 CSMA/CA 协议

凡使用 802.11 系列协议的局域网又称为 Wi-Fi(`Wireless-Fidelity`)，意思是“无线保真度”。

IEEE 802.11 规定无线局域网的最小构件是基本服务集 BSS。一个基本服务集 BSS 包括一个基站和若干个移动站，一个站无论要和本 BSS 的站进行通信，还是要和其他 BSS 的站进行通信，都必须通过本 BSS 的基站。

基本服务集内的基站叫做接入点 AP(`Access Point`) 其作用和网桥相似。当网络管理员安装 AP 时，必须为该 AP 分配一个不超过 32 字节的服务集标识符 SSID 和一个通信信道。SSID 其实就是指使用该 AP 的无线局域网的名字。

一个基本服务集 BSS 所覆盖的地理范围叫做一个基本服务区 BSA(Basic Service Area)。BSA 的范围直径一般不超过100米。

ESS 还可通过门户为无线用户提供到非 802.11 无线局域网（例如，到有线连接的互联网）的接入。门户的作用就相当于一个网桥。 

一个基本服务集可以是孤立的，也可通过接入点 AP 连接到一个主干分配系统 DS(`Distribution System`)，然后再接入到另一个基本服务集，构成扩展的服务集 ESS(`Extended Service Set`)。

{% asset_img img1.png %}

移动站 A 从某一个基本服务集漫游到另一个基本服务集（到`A'`的位置），仍可保持与另一个移动站 B 进行通信。 

#### 建立关联 (association)
一个移动站若要加入到一个基本服务集 BSS，就必须先选择一个接入点 AP，并与此接入点建立关联。建立关联就表示这个移动站加入了选定的 AP 所属的子网，并和这个 AP 之间创建了一个虚拟线路。只有关联的 AP 才能向这个移动站发送数据帧，而这个移动站也只有通过关联的 AP 才能向其他站点发送数据帧。

为了使一个基本服务集 BSS 能够为更多的移动站提供服务，往往在一个 BSS 内安装有多个接入点 AP。有时一个移动站也可以收到本基本服务集以外的 AP 信号。移动站只能在多个 AP 中选择一个建立关联。通常可以选择信号最强的一个 AP 。但有时也可能该 AP 提供的信道都已被其它移动站使用了。在这种情况下，也只能与信号强度稍差些的 AP 建立关联。

此后，这个移动站点就和选定的 AP 互相使用 802.11 关联协议进行对话。移动站点还要向该 AP 鉴别自身。在关联阶段过后，移动站点要通过关联的 AP 向该子网发送 DHCP 发现报文以获取 IP 地址。这时，互联网中的其它部分就把这个移动站点当做该 AP 子网中的一台主机。
#### 重建关联 (reassociation) 和分离 (dissociation)
若移动站使用重建关联服务，就可把这种关联转移到另一个接入点。当使用分离服务时，就可终止这种关联。
#### 移动站与 AP 建立关联的方法
* 被动扫描：移动站等待接收接入站周期性发出的信标帧。信标帧中包含有若干系统参数（如服务集标识符 SSID 以及支持的速率等）。
* 主动扫描：移动站主动发出探测请求帧，然后等待从 AP 发回的探测响应帧。

#### 热点 (hot spot)
热点就是公众无线入网点。由许多热点和 AP 连接起来的区域叫做热区。

用户可以通过无线信道接入到无线互联网服务提供者 WISP(`Wireless Internet Service Provider`)，然后再经过无线信道接入到互联网。
#### 接入安全
无线局域网用户在和附近的接入点 AP 建立关联时，一般还要键入用户密码。

初期的接入加密方案称为 WEP(`Wired Equivalent Privacy`，意思是有线等效的保密）。

现在的接入加密方案为 WPA(`WiFi Protected Access`，意思是“无线局域网受保护的接入”) 或 WPA2。
### 移动自组网络
移动自组网络又称为自组网络。自组网络是没有固定基础设施（即没有 AP）的无线局域网。这种网络是由一些处于平等状态的移动站之间相互通信组成的临时网络。

{% asset_img img2.png %}

三个主要问题：路由选择协议，多播，安全。

自组网络的服务范围通常是受限的，而且一般也不和外界的其他网络相连接。移动自组网络也就是移动分组无线网络。
#### 移动自组网络的应用前景 
* 携带了移动站的作战人员可利用临时建立的移动自组网络进行通信。
* 作战的地面车辆群和坦克群，以及海上的舰艇群、空中的机群组网。
* 在抢险救灾时，迅速组建移动自组网络实现通信。

#### 无线传感器网络 WSN
无线传感器网络 WSN(`Wireless Sensor Network`) 是由大量传感器结点通过无线通信技术构成的自组网络。

无线传感器网络的应用是进行各种数据的采集、处理和传输。特点：
* 不需要很高的带宽，必须保持低功耗。
* 对协议栈的大小有严格的限制。
* 对网络安全性、结点自动配置、网络动态重组等方面有一定的要求。 

#### 传感器结点的组成

{% asset_img img3.png %}

#### 无线传感器网络主要的应用领域
无线传感器网络主要的应用领域就是组成各种物联网 IoT (Internet of Things) ，例如：
* 环境监测与保护；
* 战争中对敌情的侦查和对兵力、装备、物资等的监控；
* 医疗中对病房的监测和对患者的护理；
* 在危险的工业环境中的安全监测；
* 城市交通管理、建筑内的温度/照明/安全控制等。

#### 移动自组网络不同于移动 IP
移动 IP 技术使漫游的主机可以用多种方式连接到互联网。

移动 IP 的核心网络功能仍然是基于在固定互联网中一直在使用的各种路由选择协议。

移动自组网络是将移动性扩展到无线领域中的自治系统，它具有自己特定的路由选择协议，并且可以不和互联网相连。 
#### 几种不同的接入
固定接入 (fixed access) —— 在作为网络用户期间，用户设置的地理位置保持不变。
移动接入 (mobility access) —— 用户设置能够以车辆速度移动时进行网络通信。当发生切换时，通信仍然是连续的。
便携接入 (portable access) —— 在受限的网络覆盖面积中，用户设备能够在以步行速度移动时进行网络通信，提供有限的切换能力。
游牧接入 (nomadic access) —— 用户设备的地理位置至少在进行网络通信时保持不变。如用户设备移动了位置，则再次进行通信时可能还要寻找最佳的基站。
## 802.11 局域网的物理层
802.11 标准中物理层相当复杂。根据物理层的不同（如工作频段、数据率、调制方法等），对应的标准也不同。

802.11 的物理层有以下几种实现方法：
* 直接序列扩频 DSSS
* 正交频分复用 OFDM 
* 跳频扩频 FHSS （已很少用）
* 红外线 IR （已很少用） 

## 802.11 局域网的 MAC 层协议
### CSMA/CA 协议
无线局域网不能简单地搬用 CSMA/CD 协议。因为：
* “碰撞检测”要求一个站点在发送本站数据的同时，还必须不间断地检测信道，但接收到的信号强度往往会远远小于发送信号的强度，在无线局域网的设备中要实现这种功能就花费过大。
* 即使能够实现碰撞检测的功能，并且在发送数据时检测到信道是空闲的时候，在接收端仍然有可能发生碰撞。

### 无线局域网的特殊问题
{% asset_img img5.png %}

A 和 C 检测不到彼此的无线信号，都以为 B 是空闲的，因而都向 B 发送数据，结果发生碰撞。

这种未能检测出媒体上已存在的信号的问题叫做隐蔽站问题。 

{% asset_img img6.png %}

B 向 A 发送数据，而 C 又想和 D 通信。C 检测到媒体上有信号，于是就不敢向 D 发送数据。

其实 B 向 A 发送数据并不影响 C 向 D 发送数据这就是暴露站问题(`exposed station problem`) 。

无线局域网不能使用 CSMA/CD，而只能使用改进的 CSMA 协议。改进的办法是把 CSMA 增加一个碰撞避免 CA(`Collision Avoidance`) 功能。802.11 就使用 CSMA/CA 协议。在使用 CSMA/CA 的同时，还增加使用停止等待协议。
### 802.11 的 MAC 层 
MAC 层通过协调功能来确定在基本服务集 BSS 中的移动站在什么时间能发送数据或接收数据。 

DCF 子层在每一个结点使用 CSMA 机制的分布式接入算法，让各个站通过争用信道来获取发送权。因此 DCF 向上提供争用服务。

PCF 子层使用集中控制的接入算法把发送数据权轮流交给各个站从而避免了碰撞的产生。自组网络就没有 PCF 子层。 
### 帧间间隔 IFS 
所有的站在完成发送后，必须再等待一段很短的时间（继续监听）才能发送下一帧。这段时间的通称是帧间间隔 IFS(`InterFrame Space`)。

帧间间隔长度取决于该站欲发送的帧的类型。高优先级帧需要等待的时间较短，因此可优先获得发送权。

若低优先级帧还没来得及发送而其他站的高优先级帧已发送到媒体，则媒体变为忙态，因而低优先级帧就只能再推迟发送了。这样就减少了发生碰撞的机会。 
### 两种常用的帧间间隔 
SIFS，即短帧间间隔，长度为28 μs，是最短的帧间间隔，用来分隔开属于一次对话的各帧。一个站应当能够在这段时间内从发送方式切换到接收方式。

使用 SIFS 的帧类型有：ACK 帧、CTS 帧、由过长的 MAC 帧分片后的数据帧，以及所有回答 AP 探询的帧和在 PCF 方式中接入点 AP 发送出的任何帧。

DIFS，即分布协调功能帧间间隔，它比 SIFS 的帧间间隔要长得多，长度为 128 μs 。在 DCF 方式中，DIFS 用来发送数据帧和管理帧。
### CSMA/CA 协议的原理 
欲发送数据的站先检测信道。在 802.11 标准中规定了在物理层的空中接口进行物理层的载波监听。

通过收到的相对信号强度是否超过一定的门限数值就可判定是否有其他的移动站在信道上发送数据。

当源站发送它的第一个 MAC 帧时，若检测到信道空闲，则在等待一段时间 DIFS 后就可发送。

当源站发送它的第一个 MAC 帧时，若检测到信道空闲，则在等待一段时间 DIFS 后，信道若仍然空闲，就开始发送。

目的站若正确收到此帧，则经过时间间隔 SIFS 后，向源站发送确认帧 ACK。

为什么信道空闲还要再等待 
这是考虑到可能有其他的站有高优先级的帧要发送。
如有，就要让高优先级帧先发送。

假定没有高优先级帧要发送 
源站发送了自己的数据帧。
目的站若正确收到此帧，则经过时间间隔 SIFS 后，向源站发送确认帧 ACK。
若源站在规定时间内没有收到确认帧 ACK（由重传计时器控制这段时间），就必须重传此帧，直到收到确认为止，或者经过若干次的重传失败后放弃发送。 

虚拟载波监听 
虚拟载波监听 (Virtual Carrier Sense) 的机制是让源站将它要占用信道的时间（包括目的站发回确认帧所需的时间）通知给所有其他站，以便使其他所有站在这一段时间都停止发送数据。这样就大大减少了碰撞的机会。 
“虚拟载波监听”是指：其他站实际上并没有监听信道，而是由于其他站收到了“源站的通知”才不发送数据。
所谓“源站的通知”就是源站在其 MAC 帧首部中的第二个字段“持续时间”中填入了在本帧结束后还要占用信道多少时间（以微秒为单位），包括目的站发送确认帧所需的时间。 

网络分配向量 
当一个站检测到正在信道中传送的 MAC 帧首部的“持续时间”字段时，就调整自己的网络分配向量 NAV (Network Allocation Vector)。
NAV 指出：必须经过多少时间才能完成数据帧的这次传输，才能使信道转入到空闲状态。 

争用窗口
信道从忙态变为空闲时，任何一个站要发送数据帧时，不仅都必须等待一个 DIFS 的间隔，而且还要进入争用窗口，并计算随机退避时间以便再次重新试图接入到信道。
在信道从忙态转为空闲时，为了避免几个站同时发送数据（一旦发送就要把一帧发送完，不能中途停止），各站就要执行退避算法，以减少发生碰撞的概率。
802.11 使用二进制指数退避算法。 

二进制指数退避算法 
第 i 次退避就在 22+i 个时隙中随机地选择一个，即：第 i 次退避是在时隙 {0, 1, …, 22+i – 1} 中随机地选择一个。 
第 1 次退避是在 8 个时隙中随机选择一个。
第 2 次退避是在 16 个时隙中随机选择一个。 
当时隙编号达到 255 时（这对应于第 6 次退避）就不再增加了。
这里决定退避时间的变量 i 称为退避变量。

退避计时器 (backoff timer)
站点每经历一个时隙的时间就检测一次信道。
这可能发生两种情况：
若检测到信道空闲，退避计时器就继续倒计时。
若检测到信道忙，就冻结退避计时器的剩余时间，重新等待信道变为空闲，并再经过时间 DIFS 后，从剩余时间开始继续倒计时。当退避计时器的时间减小到零时，就开始发送整个数据帧。 

冻结退避计时器剩余时间的做法是为了使协议对所有站点更加公平。
### 802.11 的退避机制

### 退避算法的使用情况
仅在下面的情况下才不使用退避算法：
检测到信道是空闲的，并且这个数据帧是要发送的第一个数据帧。
除此以外的所有情况，都必须使用退避算法：
在发送第一个帧之前检测到信道处于忙态。
在每一次的重传后。
在每一次的成功发送后。 
### CSMA/CA算法归纳
若站点最初有数据要发送（而不是发送不成功再进行重传），且检测到信道空闲，在等待时间 DIFS 后，就发送整个数据帧。
否则，站点就要等检测到信道空闲并经过时间 DIFS 后，执行 CSMA/CA 协议的退避算法，启动退避计数器。在退避计数器减少到零之前，一旦检测到信道忙，就冻结退避计时器。一旦信道空闲，退避计时器就进行倒计时。
当退避计时器时间减少到零时（这时信道只可能是空闲的），站点就发送整个的帧并等待确认。
发送站若收到确认，就知道已发送的帧被目的站正确收到了。这时如果要发送第二帧，就要从上面的步骤 (2) 开始，执行 CSMA/CA 协议的退避算法，随机选定一段退避时间。若源站在规定时间内没有收到确认帧 ACK（由重传计时器控制这段时间），就必须重传此帧   （再次使用 CSMA/CA 协议争用接入信道），直到收到确认为止，或者经过若干次的重传失败后放弃发送。
### 对信道进行预约 
为了更好地解决隐蔽站带来的碰撞问题，802.11 允许要发送数据的站对信道进行预约。

使用 RTS 帧和 CTS 帧会使整个网络的通信效率有所下降。但与数据帧相比，开销不算大。
相反，若不使用这种控制帧，则一旦发生碰撞而导致数据帧重发，则浪费的时间就更多。

虽然如此，协议还是设有三种情况供用户选择：
使用 RTS 帧和 CTS 帧；
只有当数据帧的长度超过某一数值时才使用 RTS 帧和 CTS 帧（显然，当数据帧本身就很短时，再使用 RTS 帧和 CTS 帧只能增加开销）；
不使用 RTS 帧和 CTS 帧。
虽然协议经过了精心设计，但碰撞仍然会发生。

CSMA/CA 协议的基本流程图


## 802.11 局域网的 MAC 帧
802.11 帧共有三种类型：控制帧、数据帧和管理帧。

{% asset_img img13.png %}
{% asset_img img14.png %}

### 802.11 数据帧的三大部分 
MAC 首部，共 30 字节。帧的复杂性都在帧的首部。
帧主体，也就是帧的数据部分，不超过 2312 字节。这个数值比以太网的最大长度长很多。不过 802.11 帧的长度通常都小于 1500 字节。
帧检验序列 FCS 是尾部，共 4 字节 。
#### 1. 关于 802.11 数据帧的地址
802.11 数据帧最特殊的地方就是有四个地址字段。地址 4 用于自组网络。我们在这里只讨论前三种地址。 