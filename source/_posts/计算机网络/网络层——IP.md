---
title: 网络层——网际协议IP
date: 2020-09-20 11:32:13
tags: 计算机网络
categories: 计算机网络
---

与IP协议配套使用的有3个协议：
* 地址解析协议 ARP(`Address Resolution Protocol`)
* 网际控制报文协议 ICMP(`Internet Control Message Protocol`)
* 网际组管理协议 IGMP(`Internet Group Management Protocol`)

{% asset_img img1.png 网际层的 IP 协议及配套协议 %}

由于网际协议 IP 是用来使互联起来的许多计算机网络能够进行通信，因此 TCP/IP 体系中的网络层也被称为网际层或 IP 层。
# 虚拟互联网络
互连在一起的网络要进行通信，会遇到许多问题需要解决，如：
* 不同的寻址方案
* 不同的最大分组长度
* 不同的网络接入机制
* 不同的超时控制
* 不同的差错恢复方法
* 不同的状态报告方法
* 不同的路由选择技术
* 不同的用户接入控制
* 不同的服务（面向连接服务和无连接服务）
* 不同的管理与控制方式
* 等等

将网络互相连接起来要使用一些中间设备，根据中间设备所在的层次，可以有以下4种不同的中间设备：
* 物理层使用的中间设备叫转发器
* 数据链路层使用的中间设备叫网桥或桥接器
* 网络层使用的中间设备叫路由器
* 网络层以上使用的设备叫网关

当中间设备是转发器或网桥时，这仅仅是把一个网络扩大了，而从网络层的角度看，这仍然是一个网络，一般并不称之为网络互连。网关由于比较复杂，使用的较少。因此我们所说的网络互连时都是指用路由器进行互连的网络。路由器其实就是一台专用计算机，用来在互联网中进行路由选择。

{% asset_img img2.png 互连网络与虚拟互连网络 %}

由于参加互连的计算机网络都使用相同的网际协议 IP，因此可以把互连以后的计算机网络看成是一个虚拟互连网络。

所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。

使用 IP 协议的虚拟互连网络可简称为 IP 网。

使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。

如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的互联网(`Internet`)。

{% asset_img img3.png 分组在互联网中的传送 %}

如果我们只从网络层考虑问题，那么 IP 数据报就可以想象是在网络层中传送。

{% asset_img img4.png %}

# 分类的IP地址
## IP地址及其表示方法
整个的互联网就是一个单一、抽象的网络。IP 地址就是给互联网上的每一个主机（或路由器）的每一个接口分配一个在全世界唯一的32位标识符。IP 地址的结构使我们可以在因特网上很方便的进行寻址。

IP 地址由互联网名字和数字分配机构 ICANN(`Internet Corporation for Assigned Names and Numbers`)进行分配。
#### IP 地址的编址方法
IP 地址的编址方法共经历了三个阶段：
1. 分类的 IP 地址。
2. 子网的划分。
3. 构成超网。

所谓分类的 IP 地址就是将 IP 地址划分为若干个固定类，每一类地址都由两个固定长度的字段组成，其中第一个字段是网络号（`net-id`），它标志主机（或路由器）所连接到的网络，一个网络号在整个互联网范围内必须是唯一的。第二个字段是主机号（`host-id`），它标志该主机（或路由器）。一个主机号在它前面的网络号所指明的范围内必须是唯一的。由此可见，一个 IP 地址在整个互联网范围内是唯一的。
#### 各类 IP 地址的网络号字段和主机号字段

{% asset_img img5.png IP 地址中的网络号字段和主机号字段 %}

A 类、B 类和 C 类都是单播地址（一对一通信）。

从图中可以看出：
* A 类、B 类和 C 类地址的网络号字段分别是1, 2, 3个字节长，在网络号字段的最前面有1~3位的类别位，其数值分别规定为0, 10, 110。
* A 类、B 类和 C 类地址的主机号字段分别为3, 2, 1个字节长。
* D 类地址（前4位是`1110`）用于多播（一对多通信）。
* E 类地址（前4位是`1111`）保留为以后用。

由于近年来已经广泛使用无分类 IP 地址进行路由选择，A 类、B 类和 C 类地址的区分已成为历史。

把 IP 地址划分为 A 类、B 类、C 类三个类别，当初是这样考虑的。各种网络的差异很大，有的网络拥有很多主机，而有的网络上的主机则很少。把 IP 地址划分为 A 类、B 类和 C 类是为了更好地满足不同用户的要求。当某个单位申请到一个 IP 地址时，实际上是获得了具有同样网络号的一块地址。其中具体的各台主机号则由该单位自行分配，只要做到在该单位管辖的范围内无重复的主机号即可。
#### 点分十进制记法 
IP 地址都是32位二进制代码。为了提高可读性，我们常常把 32 位的 IP 地址中的每 8 位用其等效的十进制数字表示，并且在这些数字之间加上一个点，这叫点分十进制法。

{% asset_img img6.png IP 点分十进制记法 %}
<br>
{% asset_img img7.png IP 点分十进制记法举例 %}

### 常用的三种类别的IP地址
A 类地址的网络号字段占1个字节，只有7位可供使用（第一位已固定为0），但可指派的网络号是126个（即2<sup>7</sup> - 2）。

减2的原因：
1. IP 地址中的全 0 是保留地址，意思是本网络。
2. 网络号为 127（即`01111111`）保留作为本地软件环回测试（`loopback test`）本主机的进程之间的通信。若主机发送一个 IP 地址为环回地址（如`127.0.0.1`）的 IP 数据报，则本机中的协议软件就处理数据报中的数据，而不会把数据报发送到任何网络。

A 类地址的主机号占 3 个字节，因此每一个 A 类网络中的最大主机数是 2<sup>24</sup> - 2。

减 2 的原因：
1. 全 0 的主机号字段表示该 IP 地址是本主机所连接到的单个网络地址。如一台主机的 IP 地址为`5.6.7.8`，则该主机所在的网络地址就是`5.0.0.0`。
2. 全 1 的主机号字段表示该网络上的所有主机。

B 类地址的网络号字段有 2 个字节，但前面两位已经固定（10），只剩下 14 位可以进行分配。因为不可能出现网络号字段全 0 或全 1，所以不存在减 2 的问题。但实际上 B 类网络地址`128.0.0.0`是不指派的，可以指派的 B 类最小网络地址是`128.1.0.0`。因此 B 类地址可指派的网络数为 2<sup>14</sup> - 1。B 类地址的每一个网络上的最大主机数是 2<sup>16</sup> - 2。减 2 是因为要扣除全 0 和全 1 的主机号。

C 类地址有 3 个字节的网络号字段，最前面的 3 位是（110），还有 21 位可分配。C 类网络地址`192.0.0.0`是不指派的，可以指派的 C 类最小网络地址是`192.0.1.0`，因此 C 类地址可指派的网络总数是2<sup>21</sup> - 1。每一个 C 类地址的最大主机数是2<sup>8</sup> - 2。

IP 地址的指派范围：

| 网络类别 | 最大网络数 | 第一个可用的网络号 | 每个网络中最大的主机数 | 每个网络中的最大主机数 |
| :--: | :--: | :--: | :--: | :--: |
| A | 126 (2<sup>7</sup> – 2) | 1 | 126 | 16,777,214 | 16777214 |
| B | 16,383(2<sup>14</sup> - 1) | 128.1 | 191.255 | 65,534 | 65534 |
| C | 2,097,151 (2<sup>21</sup> - 1) | 192.0.1 | 223.255.255 | 254 | 254 |

一般不使用的特殊的 IP 地址，这些地址只能在特定的情况下使用：

| 网络号 | 主机号 | 源地址使用 | 目标地址使用 | 代表的意思 |
| :--: | :--: | :--: | :--: | :--: |
| 0 | 0 | 可以 | 不可 | 在本网络上的本主机 |
| 0 | host-id | 可以 | 不可 | 在本网络上的某台主机 host-id |
| 全1 | 全1 | 不可 | 可以 | 只在本网络上进行广播（各路由器均不转发） |
| net-id | 全1 | 不可 | 可以 | 对 net-id 上的所有主机进行广播 |
| 127 | 非全0或全1的任何数 | 可以 | 可以 | 用于本地软件环回测试 |

### IP 地址的一些重要特点
* 每个 IP 地址都由网络号和主机号组成。IP 地址是一种分等级的地址结构。分两个等级的好处：
 * 第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。
 * 第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。 
* IP 地址是标志一个主机（或路由器）和一条链路的接口。当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号`net-id`必须是不同的。这种主机称为多归属主机。由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此一个路由器至少应当有两个不同的 IP 地址。 
* 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号`net-id`。具有不同网络号的局域网必须使用路由器进行互连。

{% asset_img img8.png 互联网中的 IP 地址 %}

图中画出了三个局域网 LAN1、LAN2、LAN3，通过 3 个路由器 R1、R2、R3 互连起来所构成的一个互联网（虚线圆角方框表示）。局域网 LAN2 是由两个网段通过网桥 B 互连的。小圆圈表示需要有一个 IP 地址。

我们应当注意到：
1. 在同一个局域网上的主机或路由器的 IP 地址中的网络号必须是一样的。
2. 用网桥（它只在链路层工作）互连的网络仍然是一个局域网，只能有一个网络号。
3. 路由器总是具有两个或两个以上的 IP 地址。即路由器的每一个接口都有一个不同网络号的 IP 地址。 
4. 当两个路由器直接相连时，在连接两端的接口处，可以分配也可以不分配 IP 地址。如果分配了 IP 地址，则这一段连线就构成了一种只包含一段线路的特殊“网络”（N1、N2、N3）。现在常不指明 IP 地址。这样的特殊网络叫无编号网络或无名网络。

## IP 地址与硬件地址

{% asset_img img9.png IP 地址与硬件地址的区别 %}

从层次的角度看，物理地址是数据链路层和物理层使用的地址，IP 地址是网络层和以上各层使用的地址，是一种逻辑地址，因为 IP 地址是用软件实现的。

在发送数据时，数据从高层下到低层，然后才到通信链路上传输。使用 IP 地址的 IP 数据报一旦交给了数据链路层，就被封装成 MAC 帧了。MAC 帧在传输时使用的源地址和目标地址都是硬件地址，这两个硬件地址都写在 MAC 帧的首部中。

连接在通信链路上的设备（主机或路由器）在接收 MAC 帧时，其根据是 MAC 帧首部中的硬件地址。在数据链路层看不见隐藏在 MAC 帧的数据中的 IP 地址。只有在剥去 MAC 帧的首部和尾部后把 MAC 层的数据上交给网络层后，网络层才能在 IP 数据报的首部中找到源 IP 地址和目的 IP 地址。

{% asset_img img10.png %}

上图画的是3个局域网用两个路由器R1、R2互连起来。现在主机 H1 和主机 H2 通信。这两个主机的 IP 地址分别为 IP1、IP2，它们的硬件地址分别为HA1、HA2。通信的路径是：H1 → 经过 R1 转发 → 再经过 R2 转发 → H2。

路由器 R1 因同时连接到两个局域网上，因此它有两个硬件地址，HA3、HA4。同理，路由器 R2有两个硬件地址 HA5、HA6。

{% asset_img img11.png %}
{% asset_img img12.png %}
{% asset_img img13.png %}

在 IP 层抽象的互联网上只能看到 IP 数据报。图中的 IP1 → IP2 表示从源地址 IP1 到目的地址 IP2，两个路由器的 IP 地址并不出现在 IP 数据报的首部中。

路由器只根据目的站的 IP 地址的网络号进行路由选择。

在具体的物理网络的链路层只能看见 MAC 帧而看不见 IP 数据报。

IP层抽象的互联网屏蔽了下层很复杂的细节，在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信。

主机 H1 与 H2 通信中使用的IP地址 与 硬件地址 HA

{% asset_img img14.png %}

# 地址解析协议ARP
通信时使用了两个地址：IP 地址（网络层地址）、MAC 地址（数据链路层地址）。
## 地址解析协议 ARP 的作用
{% asset_img img15.png %}

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。

但 IP 地址和下面的网络的硬件地址之间由于格式不同而不存在简单的映射关系（IP 地址有32位，硬件地址48位）。此外，一个网络上可能经常会有新的主机加入进来，或撤走一些主机。更换网络适配器也会使主机的硬件地址改变。ARP 解决这个问题的办法是在主机 ARP 高速缓存中存放一个从 IP 地址到硬件地址的映射表，并且这个映射表还经常动态更新。

每一个主机都设有一个 ARP 高速缓存(`ARP cache`)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

{% asset_img img16.png %}

当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。
* 如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。
* 如没有， ARP 进程在本局域网上广播发送一个 ARP 请求分组。收到 ARP 响应分组后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存。

ARP请求分组：包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址(未知时填 0) / 目标方 IP 地址。

本地广播 ARP 请求（路由器不转发ARP请求）。

ARP 响应分组：包含发送方硬件地址 / 发送方 IP地址 / 目标方硬件地址 / 目标方 IP 地址。

ARP 分组封装在物理网络的帧中传输。

{% asset_img img17.png %}

## ARP 高速缓存的作用
存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。

为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。

当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。
## 应当注意的问题
ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。

如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。

从 IP 地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。
只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址。 
## 使用 ARP 的四种典型情况

{% asset_img img18.png %}

使用 ARP 的四种典型情况：
* 发送方是主机，要把 IP 数据报发送到本网络上的另一个主机。这时用 ARP 找到目的主机的硬件地址。 
* 发送方是主机，要把 IP 数据报发送到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 
* 发送方是路由器，要把 IP 数据报转发到本网络上的一个主机。这时用 ARP 找到目的主机的硬件地址。 
* 发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。 

## 不直接使用硬件地址进行通信的原因
由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。

IP 编址把这个复杂问题解决了。连接到互联网的主机只需各自拥有一个唯一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用 ARP 的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。

因此，在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。
# IP数据报的格式
IP 数据报的格式能够说明 IP 协议都具有什么功能。

{% asset_img img19.png IP数据报的格式 %}

一个 IP 数据报由首部和数据两部分组成。首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。
## 各字段含义
### IP 数据报首部的固定部分中的各字段含义：
1. 版本：占 4 位，指 IP 协议的版本。通信双方使用的 IP 协议的版本必须一致。
2. 首部长度：占 4 位，可表示的最大数值是 15个单位，因此 IP 的首部长度的最大值是 60 字节。
3. 区分服务：占 8 位，用来获得更好的服务。只有在使用区分服务（`DiffServ`）时，这个字段才起作用。在一般的情况下都不使用这个字段。 
4. 总长度：占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 2<sup>16</sup> - 1。总长度必须不超过最大传送单元 MTU。
5. 标识：占 16 位，它是一个计数器，用来产生数据报的标识。
6. 标志：占 3 位，目前只有前两位有意义。
标志字段的最低位是 MF(`More Fragment`)。MF = 1 表示后面“还有分片”。MF = 0 表示最后一个分片。
标志字段中间的一位是 DF(`Don't Fragment`) 。只有当 DF = 0 时才允许分片。 
7. 片偏移：占 13 位，指出：较长的分组在分片后某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。
8. 生存时间：占 8 位，记为 TTL(`Time To Live`)，数据报在网络中可通过的路由器数的最大值。数据报能在因特网中经过的路由器的最大数值是255。TTL = 1 表示这个数据报只能在本局域网中传送。
9. 协议：占 8 位，字段指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给哪个处理过程。
10. 首部校验和：占 16 位，只校验数据报的首部，不包括数据部分。这里不采用 CRC 检验码而采用简单的计算方法。
11. 源地址：占 32 位。
12. 目的地址：占 32位。

IP 数据报首部检验和的计算过程：

{% asset_img img20.png %}

### IP 数据报首部的可变部分
IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。

选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目。

增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。

实际上这些选项很少被使用。
## IP层转发分组的流程
假设：有四个 A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。

可以想象，若按目的主机号来制作路由表，每一个路由表就有 4 万个项目，即 4 万行（每一行对应于一台主机），则所得出的路由表就会过于庞大。

但若按主机所在的网络地址来制作路由表，那么每一个路由器中的路由表就只包含 4 个项目（每一行对应于一个网络），这样就可使路由表大大简化。

在路由表中，对每一条路由，最主要的是（目的网络地址，下一跳地址）。

{% asset_img img21.png %}

根据目的网络地址就能确定下一跳路由器，这样做的结果是：IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）。只有到达最后一个路由器时，才试图向目的主机进行直接交付。 

虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。

采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。

路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间。

这种转发方式在一个网络只有很少的对外连接时是很有用的。

默认路由在主机发送 IP 数据报时往往更能显示出它的好处。

如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的。

{% asset_img img22.png %}

只要目的网络不是 N1 和 N2，就一律选择默认路由，把数据报先间接交付路由器 R1，让 R1 再转发给下一个路由器。 

必须强调指出，IP 数据报的首部中没有地方可以用来指明“下一跳路由器的 IP 地址”。

当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是送交下层的网络接口软件。

网络接口软件使用 ARP 负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。
### 路由器分组转发算法
1. 从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N。
2. 若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行3。
3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行4。
4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行5。
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行6。
6. 报告转发分组出错。 

路由表没有给分组指明到某个网络的完整路径。

路由表指出，到某个网络应当先到某个路由器（即下一跳路由器）。在到达下一跳路由器后，再继续查找其路由表，知道再下一步应当到哪一个路由器。这样一步一步地查找下去，直到最后到达目的网络。
