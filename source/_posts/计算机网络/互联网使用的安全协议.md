

# 网络层安全协议
IP 安全性很差：
没有为通信提供良好的数据源鉴别机制；
没有为数据提供强大的完整性保护机制；
没有为数据提供任何机密性保护；
在设计和实现上存在安全漏洞，使各种攻击有机可乘。例如：攻击者很容易构造一个包含虚假地址的 IP 数据报。

IP 几乎不具备任何安全性，不能保证：
数据机密性
数据完整性
数据来源认证
由于其在设计和实现上存在安全漏洞，使各种攻击有机可乘。例如：攻击者很容易构造一个包含虚假地址的 IP 数据报。
IPsec 提供了标准、健壮且包含广泛的机制保证 IP 层安全。
## IPsec 协议
IPsec 就是“IP 安全 (security)”的缩写。
IPsec 并不是一个单个的协议，而是能够在 IP 层提供互联网通信安全的协议族。
IPsec 是个框架，它允许通信双方选择合适的算法和参数（例如，密钥长度）。
为保证互操作性，IPsec 还包含了所有 IPsec 的实现都必须有的一套加密算法。

## IPsec 由三部分组成
IP 安全数据报格式的两个协议
鉴别首部 AH (Authentication Header) 协议
封装安全有效载荷 ESP (Encapsulation Security Payload) 协议
有关加密算法的三个协议（在此不讨论）
互联网密钥交换 IKE (Internet Key Exchange) 协议

AH 协议提供源点鉴别和数据完整性，但不能保密。
ESP 协议比 AH 协议复杂得多，它提供源点鉴别、数据完整性和保密。
使用 ESP 或 AH 协议的 IP 数据报称为 IP 安全数据报（或 IPsec数据报）。
Ipsec 支持 IPv4 和 IPv6。
AH 协议的功能都已包含在 ESP 协议中。

IP 安全数据报有两种工作方式
运输方式 (transport mode)
在整个运输层报文段的前后分别添加若干控制信息，再加上 IP 首部，构成 IP 安全数据报。
适合于主机到主机之间的安全传送。 
需要使用 IPsec 的主机都运行 IPsec 协议。

{% asset_img img1.png %}

隧道方式 (tunnel mode) 
在原始的 IP 数据报的前后分别添加若干控制信息，再加上新的 IP 首部，构成一个 IP 安全数据报。
需要在 IPsec 数据报所经过的所有路由器上都运行 IPsec 协议。
隧道方式常用来实现虚拟专用网 VPN。

{% asset_img img2.png %}

无论使用哪种方式，最后得出的 IP 安全数据报的 IP 首部都是不加密的。
所谓“安全数据报”是指数据报的数据部分是经过加密的，并能够被鉴别的。
通常把数据报的数据部分称为数据报的有效载荷 (payload)。

在发送 IP 安全数据报之前，在源实体和目的实体之间必须创建一条网络层的逻辑连接。此逻辑连接叫做安全关联 SA (Security Association) 。
IPsec 就把传统互联网无连接的网络层转换为具有逻辑连接的网络层。 

安全关联的特点
安全关联是从源点到终点的单向连接，它能够提供安全服务。
在安全关联 SA 上传送的就是 IP 安全数据报。
如要进行双向安全通信，则两个方向都需要建立安全关联。
若 n 个员工进行双向安全通信，一共需要创建 (2 + 2n ) 条安全关联 SA。

